# This patch adds the Tor peer discovery init container to only-onion StatefulSets
# Apply with: kubectl patch statefulset <name> -n gethrelay --patch-file tor-discovery-patch.yaml

spec:
  template:
    spec:
      serviceAccountName: gethrelay-tor-discovery
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 700 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      - name: tor-peer-discovery
        image: bitnami/kubectl:latest
        command: ['/bin/sh']
        args: ['/scripts/discover-peers.sh']
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: P2P_PORT
          value: "30303"
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
          readOnly: true
        - name: geth-data
          mountPath: /data/geth
        - name: discovery-script
          mountPath: /scripts
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: discovery-script
        configMap:
          name: tor-peer-discovery-script
          defaultMode: 0755
      - name: geth-data
        emptyDir: {}
  volumeClaimTemplates:
  - metadata:
      name: tor-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
