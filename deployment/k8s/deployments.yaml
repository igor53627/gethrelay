---
# ConfigMap for common configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: gethrelay-config
  namespace: gethrelay
data:
  CHAIN: "mainnet"
  MAX_PEERS: "200"
  PORT: "30303"
  RPC_UPSTREAM: "https://ethereum-rpc.publicnode.com"
  V5DISC: "true"

---
# ConfigMap for Tor configuration with hidden service (for tor-only and prefer-tor)
apiVersion: v1
kind: ConfigMap
metadata:
  name: torrc-with-hidden-service
  namespace: gethrelay
data:
  torrc: |
    # Tor configuration for gethrelay with P2P hidden service
    # Used for tor-only and prefer-tor instances

    # SOCKS5 proxy on port 9050
    SocksPort 0.0.0.0:9050

    # Control port for hidden service management
    ControlPort 9051

    # Cookie authentication
    CookieAuthentication 1
    CookieAuthFile /var/lib/tor/control_auth_cookie
    CookieAuthFileGroupReadable 1

    # Data directory
    DataDirectory /var/lib/tor
    DataDirectoryGroupReadable 1
    CacheDirectoryGroupReadable 1

    # Hidden service configuration for P2P port
    # This creates a persistent .onion address for the gethrelay P2P service
    HiddenServiceDir /var/lib/tor/hidden_service
    HiddenServicePort 30303 127.0.0.1:30303

    # Logging
    Log notice stdout

    # Performance tuning
    MaxCircuitDirtiness 60
    CircuitBuildTimeout 30

---
# ConfigMap for basic Tor configuration (for default instances)
apiVersion: v1
kind: ConfigMap
metadata:
  name: torrc-basic
  namespace: gethrelay
data:
  torrc: |
    # Tor configuration for gethrelay
    # SOCKS5 proxy on port 9050
    SocksPort 0.0.0.0:9050

    # Control port for hidden service management
    ControlPort 9051

    # Cookie authentication
    CookieAuthentication 1
    CookieAuthFile /var/lib/tor/control_auth_cookie

    # Data directory
    DataDirectory /var/lib/tor

    # Logging
    Log notice stdout

    # Performance tuning
    MaxCircuitDirtiness 60
    CircuitBuildTimeout 30

---
# Deployment 1: Default mode (no Tor preference)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gethrelay-default-1
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: default
    instance: "1"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: default-1
  template:
    metadata:
      labels:
        app: gethrelay
        instance: default-1
        mode: default
    spec:
      securityContext:
        fsGroup: 100
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-basic

---
# Deployment 2: Default mode (no Tor preference)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gethrelay-default-2
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: default
    instance: "2"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: default-2
  template:
    metadata:
      labels:
        app: gethrelay
        instance: default-2
        mode: default
    spec:
      securityContext:
        fsGroup: 100
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-basic

---
# Deployment 3: Default mode (no Tor preference)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gethrelay-default-3
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: default
    instance: "3"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: default-3
  template:
    metadata:
      labels:
        app: gethrelay
        instance: default-3
        mode: default
    spec:
      securityContext:
        fsGroup: 100
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-basic

---
# StatefulSet 1: Prefer Tor mode with hidden service
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gethrelay-prefer-tor-1
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: prefer-tor
    instance: "4"
spec:
  serviceName: gethrelay-prefer-tor-1
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: prefer-tor-1
  template:
    metadata:
      labels:
        app: gethrelay
        instance: prefer-tor-1
        mode: prefer-tor
    spec:
      securityContext:
        fsGroup: 100
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 750 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --prefer-tor
        - --tor-enabled
        - --tor-control=127.0.0.1:9051
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: tor-data
        emptyDir: {}

---
# StatefulSet 2: Prefer Tor mode with hidden service
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gethrelay-prefer-tor-2
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: prefer-tor
    instance: "5"
spec:
  serviceName: gethrelay-prefer-tor-2
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: prefer-tor-2
  template:
    metadata:
      labels:
        app: gethrelay
        instance: prefer-tor-2
        mode: prefer-tor
    spec:
      securityContext:
        fsGroup: 100
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 750 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --prefer-tor
        - --tor-enabled
        - --tor-control=127.0.0.1:9051
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: tor-data
        emptyDir: {}

---
# StatefulSet 3: Prefer Tor mode with hidden service
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gethrelay-prefer-tor-3
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: prefer-tor
    instance: "6"
spec:
  serviceName: gethrelay-prefer-tor-3
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: prefer-tor-3
  template:
    metadata:
      labels:
        app: gethrelay
        instance: prefer-tor-3
        mode: prefer-tor
    spec:
      securityContext:
        fsGroup: 100
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 750 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --prefer-tor
        - --tor-enabled
        - --tor-control=127.0.0.1:9051
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: tor-data
        emptyDir: {}

---
# StatefulSet 4: Prefer Tor mode with hidden service
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gethrelay-prefer-tor-4
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: prefer-tor
    instance: "7"
spec:
  serviceName: gethrelay-prefer-tor-4
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: prefer-tor-4
  template:
    metadata:
      labels:
        app: gethrelay
        instance: prefer-tor-4
        mode: prefer-tor
    spec:
      securityContext:
        fsGroup: 100
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 750 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --prefer-tor
        - --tor-enabled
        - --tor-control=127.0.0.1:9051
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: tor-data
        emptyDir: {}

---
# StatefulSet 1: Tor-Only mode with hidden service
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gethrelay-only-onion-1
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: only-onion
    instance: "8"
spec:
  serviceName: gethrelay-only-onion-1
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: only-onion-1
  template:
    metadata:
      labels:
        app: gethrelay
        instance: only-onion-1
        mode: only-onion
    spec:
      securityContext:
        fsGroup: 100
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 750 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --only-onion
        - --tor-enabled
        - --tor-control=127.0.0.1:9051
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        - --staticnodes=enode://50ff9a4548a07fa256989e5d64e9925dc86f7dcd8c59cdf87f820dabd5678d41910aaf94ddb630ec857f9f77b10b42c1b49f4a5ecccef99dcf28bc8671f5fb27@darfuqg4jxsyjib7mjoyg555bnumyxrlm3surzav2ztuy3cssjshmcad.onion:30303,enode://95f9b6e49b4a0aab08c1eaefb09ec973cbae045d95f708a9984689b11beb0d6808b15a25ff1678becefda271c55108bf089bca36cbed343cd75424368ae7e259@aotrm7ankfhfbc6eqik4trucszb2cq2sp35qlvb7ymnj6abn22shuqad.onion:30303,enode://cdd4665492e1b2ea7a2a6e4bdca9aa476df5d52fe14d954092aa0c8420deb9680a010c89d05324d085a645e4311d90e957d535282dda9cbf66caf13fc82c98ff@yaiq5ykw7wsiw4uotmpey57acgpgvyqiebu46jkmf2si6pno2d3jf3qd.onion:30303,enode://cb283d399446b7866fe29aadd39d07642952f78d5dd128dd64487ad15b9b2dc640db5b8dbe2091def609ee0af7bc8034cc44b7cde20cb59af9a1898254bc145c@culnlds77u3l72ndskb7ssxilood2xva3iecab4346mxftt3llz33iqd.onion:30303,enode://5f7223a4aa5f6199eaec0b1a5915528a1427475a36a755dea712aa08464382d37f2a9f9257f2ab7669476f1a852bf04cf6413e8a23834358b1ef8eeb7fe57071@aclfdr4zqoekesppuqjbttan3e45hzj5bbe4zseum5czvqhcpzt7j7yd.onion:30303,enode://cbe8c5ddc6a48e9595f19ece147bcfc26614dfee367a824c2bc12f611772c3fc8dff63a91720ac0db7788a5d0938a5ff56aa4825d89cfb737ad4c6e68882d1dc@rqq2z57echjpfa4rrcy3lt52sfodvrk6frojzpwdmtocb7i2vov2bwyd.onion:30303,enode://bed4aa284f614434ea8a330cd19afdcb41f1db7bbd44bb5345234b6a7bb77165a81ce74c9d0f7b1ddb5f7c110d1912ca710e2aeedbb79697e20b45913f71e9ec@ykw2rhmqtnu32rhwn5bcgqwebrhqu42ky2uzsqzbnsqko7sgbud7teqd.onion:30303
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: tor-data
        emptyDir: {}

---
# StatefulSet 2: Tor-Only mode with hidden service
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gethrelay-only-onion-2
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: only-onion
    instance: "9"
spec:
  serviceName: gethrelay-only-onion-2
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: only-onion-2
  template:
    metadata:
      labels:
        app: gethrelay
        instance: only-onion-2
        mode: only-onion
    spec:
      securityContext:
        fsGroup: 100
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 750 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --only-onion
        - --tor-enabled
        - --tor-control=127.0.0.1:9051
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        - --staticnodes=enode://50ff9a4548a07fa256989e5d64e9925dc86f7dcd8c59cdf87f820dabd5678d41910aaf94ddb630ec857f9f77b10b42c1b49f4a5ecccef99dcf28bc8671f5fb27@darfuqg4jxsyjib7mjoyg555bnumyxrlm3surzav2ztuy3cssjshmcad.onion:30303,enode://95f9b6e49b4a0aab08c1eaefb09ec973cbae045d95f708a9984689b11beb0d6808b15a25ff1678becefda271c55108bf089bca36cbed343cd75424368ae7e259@aotrm7ankfhfbc6eqik4trucszb2cq2sp35qlvb7ymnj6abn22shuqad.onion:30303,enode://cdd4665492e1b2ea7a2a6e4bdca9aa476df5d52fe14d954092aa0c8420deb9680a010c89d05324d085a645e4311d90e957d535282dda9cbf66caf13fc82c98ff@yaiq5ykw7wsiw4uotmpey57acgpgvyqiebu46jkmf2si6pno2d3jf3qd.onion:30303,enode://cb283d399446b7866fe29aadd39d07642952f78d5dd128dd64487ad15b9b2dc640db5b8dbe2091def609ee0af7bc8034cc44b7cde20cb59af9a1898254bc145c@culnlds77u3l72ndskb7ssxilood2xva3iecab4346mxftt3llz33iqd.onion:30303,enode://5f7223a4aa5f6199eaec0b1a5915528a1427475a36a755dea712aa08464382d37f2a9f9257f2ab7669476f1a852bf04cf6413e8a23834358b1ef8eeb7fe57071@aclfdr4zqoekesppuqjbttan3e45hzj5bbe4zseum5czvqhcpzt7j7yd.onion:30303,enode://cbe8c5ddc6a48e9595f19ece147bcfc26614dfee367a824c2bc12f611772c3fc8dff63a91720ac0db7788a5d0938a5ff56aa4825d89cfb737ad4c6e68882d1dc@rqq2z57echjpfa4rrcy3lt52sfodvrk6frojzpwdmtocb7i2vov2bwyd.onion:30303,enode://bed4aa284f614434ea8a330cd19afdcb41f1db7bbd44bb5345234b6a7bb77165a81ce74c9d0f7b1ddb5f7c110d1912ca710e2aeedbb79697e20b45913f71e9ec@ykw2rhmqtnu32rhwn5bcgqwebrhqu42ky2uzsqzbnsqko7sgbud7teqd.onion:30303
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: tor-data
        emptyDir: {}

---
# StatefulSet 3: Tor-Only mode with hidden service
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gethrelay-only-onion-3
  namespace: gethrelay
  labels:
    app: gethrelay
    mode: only-onion
    instance: "10"
spec:
  serviceName: gethrelay-only-onion-3
  replicas: 1
  selector:
    matchLabels:
      app: gethrelay
      instance: only-onion-3
  template:
    metadata:
      labels:
        app: gethrelay
        instance: only-onion-3
        mode: only-onion
    spec:
      securityContext:
        fsGroup: 100
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ['sh', '-c', 'chown -R 100:101 /var/lib/tor && chmod -R 750 /var/lib/tor']
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
      containers:
      - name: tor
        image: dockurr/tor:latest
        ports:
        - containerPort: 9050
          name: socks
        - containerPort: 9051
          name: control
        volumeMounts:
        - name: torrc
          mountPath: /etc/tor/torrc
          subPath: torrc
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      - name: gethrelay
        image: ghcr.io/igor53627/gethrelay:feature-monitoring-prometheus-grafana-56c6e7d
        args:
        - --chain=$(CHAIN)
        - --maxpeers=$(MAX_PEERS)
        - --port=$(PORT)
        - --v5disc
        - --tor-proxy=127.0.0.1:9050
        - --only-onion
        - --tor-enabled
        - --tor-control=127.0.0.1:9051
        - --rpc.upstream=$(RPC_UPSTREAM)
        - --pprof
        - --pprof.addr=0.0.0.0
        - --pprof.port=6060
        - --staticnodes=enode://50ff9a4548a07fa256989e5d64e9925dc86f7dcd8c59cdf87f820dabd5678d41910aaf94ddb630ec857f9f77b10b42c1b49f4a5ecccef99dcf28bc8671f5fb27@darfuqg4jxsyjib7mjoyg555bnumyxrlm3surzav2ztuy3cssjshmcad.onion:30303,enode://95f9b6e49b4a0aab08c1eaefb09ec973cbae045d95f708a9984689b11beb0d6808b15a25ff1678becefda271c55108bf089bca36cbed343cd75424368ae7e259@aotrm7ankfhfbc6eqik4trucszb2cq2sp35qlvb7ymnj6abn22shuqad.onion:30303,enode://cdd4665492e1b2ea7a2a6e4bdca9aa476df5d52fe14d954092aa0c8420deb9680a010c89d05324d085a645e4311d90e957d535282dda9cbf66caf13fc82c98ff@yaiq5ykw7wsiw4uotmpey57acgpgvyqiebu46jkmf2si6pno2d3jf3qd.onion:30303,enode://cb283d399446b7866fe29aadd39d07642952f78d5dd128dd64487ad15b9b2dc640db5b8dbe2091def609ee0af7bc8034cc44b7cde20cb59af9a1898254bc145c@culnlds77u3l72ndskb7ssxilood2xva3iecab4346mxftt3llz33iqd.onion:30303,enode://5f7223a4aa5f6199eaec0b1a5915528a1427475a36a755dea712aa08464382d37f2a9f9257f2ab7669476f1a852bf04cf6413e8a23834358b1ef8eeb7fe57071@aclfdr4zqoekesppuqjbttan3e45hzj5bbe4zseum5czvqhcpzt7j7yd.onion:30303,enode://cbe8c5ddc6a48e9595f19ece147bcfc26614dfee367a824c2bc12f611772c3fc8dff63a91720ac0db7788a5d0938a5ff56aa4825d89cfb737ad4c6e68882d1dc@rqq2z57echjpfa4rrcy3lt52sfodvrk6frojzpwdmtocb7i2vov2bwyd.onion:30303,enode://bed4aa284f614434ea8a330cd19afdcb41f1db7bbd44bb5345234b6a7bb77165a81ce74c9d0f7b1ddb5f7c110d1912ca710e2aeedbb79697e20b45913f71e9ec@ykw2rhmqtnu32rhwn5bcgqwebrhqu42ky2uzsqzbnsqko7sgbud7teqd.onion:30303
        envFrom:
        - configMapRef:
            name: gethrelay-config
        ports:
        - containerPort: 30303
          name: p2p
          protocol: TCP
        - containerPort: 6060
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: tor-data
          mountPath: /var/lib/tor
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: torrc
        configMap:
          name: torrc-with-hidden-service
      - name: tor-data
        emptyDir: {}
