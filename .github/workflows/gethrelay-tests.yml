name: Gethrelay Tests

on:
  push:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  notify-start:
    name: Notify Start
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false'
    steps:
      - name: Send Telegram notification (workflow started)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            üöÄ *gethrelay CI Started*
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            *Author:* ${{ github.actor }}
            *Workflow:* ${{ github.workflow }}
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [notify-start]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Run unit tests
        working-directory: ./cmd/gethrelay
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic .

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./cmd/gethrelay/coverage.out
          flags: gethrelay
          name: gethrelay-coverage

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [unit-tests]
    outputs:
      image: ${{ steps.meta.outputs.tags }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ethereum/gethrelay
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=gethrelay-$(git rev-parse HEAD:cmd/gethrelay/Dockerfile.gethrelay)-$(git rev-parse HEAD:go.mod)-$(git rev-parse HEAD:go.sum)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          file: ./cmd/gethrelay/Dockerfile.gethrelay
          push: false
          tags: ethereum/gethrelay:latest,ethereum/gethrelay:${{ github.sha }}
          load: true
          cache-from: |
            type=gha,scope=gethrelay-deps
            type=gha,scope=gethrelay-builder
            type=gha,scope=gethrelay
          cache-to: |
            type=gha,mode=max,scope=gethrelay-deps
            type=gha,mode=max,scope=gethrelay-builder
            type=gha,mode=max,scope=gethrelay
          build-args: |
            GO_VERSION=${{ env.GO_VERSION }}
            COMMIT=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            BUILDNUM=${{ github.run_number }}
          platforms: linux/amd64

      - name: Verify image exists
        run: |
          docker images | grep gethrelay
          docker inspect ethereum/gethrelay:latest

      - name: Save image
        run: |
          docker save ethereum/gethrelay:latest -o /tmp/gethrelay-image.tar
          gzip -f /tmp/gethrelay-image.tar
          ls -lh /tmp/gethrelay-image.tar.gz
          file /tmp/gethrelay-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp/gethrelay-image.tar.gz
          retention-days: 1
          compression-level: 0

  hive-tests:
    name: Hive Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp

      - name: Load Docker image
        run: |
          echo "Checking downloaded file..."
          ls -lh /tmp/gethrelay-image.tar.gz
          echo "Loading Docker image..."
          gunzip -c /tmp/gethrelay-image.tar.gz | docker load || {
            echo "Error loading image, trying alternative method..."
            gunzip /tmp/gethrelay-image.tar.gz
            docker load -i /tmp/gethrelay-image.tar
          }
          echo "Verifying image loaded..."
          docker images | grep gethrelay

      - name: Set up Hive
        run: |
          git clone --depth=1 https://github.com/ethereum/hive.git /tmp/hive
          cd /tmp/hive && go build -o /usr/local/bin/hive .

      - name: Setup Hive client configuration
        run: |
          mkdir -p /tmp/hive/clients/gethrelay
          cp -r /tmp/hive/clients/go-ethereum/* /tmp/hive/clients/gethrelay/ || true
          cat > /tmp/hive/clients/gethrelay/hive.yaml << 'EOF'
          roles:
            - "eth1"
            - "relay"
            - "rpc"
          EOF
          cat > /tmp/hive/clients/gethrelay/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          RUN apk add --update bash curl jq
          ADD gethrelay.sh /gethrelay.sh
          RUN chmod +x /gethrelay.sh
          EXPOSE 8545 30303 30303/udp
          ENTRYPOINT ["/gethrelay.sh"]
          EOF

      - name: Tag image for Hive
        run: |
          docker tag ethereum/gethrelay:latest hive/clients/gethrelay:local

      - name: Run RPC tests
        working-directory: /tmp/hive
        run: |
          hive --sim=ethereum/rpc \
               --client=gethrelay:local \
               --loglevel=3 \
               --sim.timelimit=15m \
               --results-root=./test-results
        continue-on-error: true

      - name: Run devp2p tests
        working-directory: /tmp/hive
        run: |
          hive --sim=devp2p \
               --client=gethrelay:local \
               --loglevel=3 \
               --sim.timelimit=15m \
               --results-root=./test-results
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hive-test-results
          path: /tmp/hive/test-results
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo "## Hive Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RPC Tests" >> $GITHUB_STEP_SUMMARY
          grep -c "pass=true" /tmp/hive/test-results/*/simulator.log || echo "No results found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### devp2p Tests" >> $GITHUB_STEP_SUMMARY
          grep -c "pass=true" /tmp/hive/test-results/*/simulator.log || echo "No results found" >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: success() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (success)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ‚úÖ *gethrelay CI Passed*
            
            All tests completed successfully!
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: failure() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (failure)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ‚ùå *gethrelay CI Failed*
            
            Some tests or builds failed. Please check the logs.
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

