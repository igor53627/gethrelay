name: Gethrelay Tests

on:
  push:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  notify-start:
    name: Notify Start
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false'
    steps:
      - name: Send Telegram notification (workflow started)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            üöÄ *gethrelay CI Started*
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            *Author:* ${{ github.actor }}
            *Workflow:* ${{ github.workflow }}
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [notify-start]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Run unit tests
        working-directory: ./cmd/gethrelay
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic .

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./cmd/gethrelay/coverage.out
          flags: gethrelay
          name: gethrelay-coverage

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [unit-tests]
    outputs:
      image: ${{ steps.meta.outputs.tags }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ethereum/gethrelay
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=gethrelay-$(git rev-parse HEAD:cmd/gethrelay/Dockerfile.gethrelay)-$(git rev-parse HEAD:go.mod)-$(git rev-parse HEAD:go.sum)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          file: ./cmd/gethrelay/Dockerfile.gethrelay
          push: false
          tags: ethereum/gethrelay:latest,ethereum/gethrelay:${{ github.sha }}
          load: true
          cache-from: |
            type=gha,scope=gethrelay-deps
            type=gha,scope=gethrelay-builder
            type=gha,scope=gethrelay
          cache-to: |
            type=gha,mode=max,scope=gethrelay-deps
            type=gha,mode=max,scope=gethrelay-builder
            type=gha,mode=max,scope=gethrelay
          build-args: |
            GO_VERSION=${{ env.GO_VERSION }}
            COMMIT=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            BUILDNUM=${{ github.run_number }}
          platforms: linux/amd64

      - name: Verify image exists
        run: |
          docker images | grep gethrelay
          docker inspect ethereum/gethrelay:latest

      - name: Save image
        run: |
          docker save ethereum/gethrelay:latest -o /tmp/gethrelay-image.tar
          gzip -f /tmp/gethrelay-image.tar
          ls -lh /tmp/gethrelay-image.tar.gz
          file /tmp/gethrelay-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp/gethrelay-image.tar.gz
          retention-days: 1
          compression-level: 0

  hive-tests:
    name: Hive Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp

      - name: Load Docker image
        run: |
          echo "Checking downloaded file..."
          ls -lh /tmp/gethrelay-image.tar.gz
          echo "Loading Docker image..."
          gunzip -c /tmp/gethrelay-image.tar.gz | docker load || {
            echo "Error loading image, trying alternative method..."
            gunzip /tmp/gethrelay-image.tar.gz
            docker load -i /tmp/gethrelay-image.tar
          }
          echo "Verifying image loaded..."
          docker images | grep gethrelay

      - name: Set up Hive
        run: |
          git clone --depth=1 https://github.com/ethereum/hive.git /tmp/hive
          cd /tmp/hive && go build -o /usr/local/bin/hive .
          
      - name: Verify workflow file version
        run: |
          echo "=== Workflow Version Check ==="
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Branch: $(git branch --show-current)"
          echo "Workflow file last modified:"
          git log -1 --format="%ai %h %s" -- .github/workflows/gethrelay-tests.yml || echo "Cannot get git info"
          echo ""
          echo "Checking for diagnostic steps (should see 'Verify Hive setup' step):"
          grep -c "Verify Hive setup" .github/workflows/gethrelay-tests.yml && echo "‚úì Diagnostic steps found" || echo "‚úó Diagnostic steps missing"
          echo ""
          
      - name: Verify Hive setup and available simulators
        working-directory: /tmp/hive
        run: |
          echo "=== Hive Setup Verification ==="
          echo ""
          echo "1. Hive binary location and version:"
          which hive || echo "hive not in PATH"
          /usr/local/bin/hive --version 2>&1 || hive --version 2>&1 || echo "Cannot get version"
          echo ""
          echo "2. Checking simulators directory:"
          if [ -d "simulators" ]; then
            echo "‚úì Simulators directory exists"
            echo "Available simulators:"
            ls -d simulators/*/ 2>/dev/null | sed 's|simulators/||' | sed 's|/||' | head -20
            echo ""
            echo "3. Checking for specific simulators:"
            if [ -d "simulators/ethereum/rpc" ]; then
              echo "‚úì ethereum/rpc simulator found"
              ls -la simulators/ethereum/rpc/ | head -10
            else
              echo "‚úó ethereum/rpc simulator NOT found"
              echo "Trying alternative paths..."
              find . -name "*rpc*" -type d | grep -i simulator | head -5
            fi
            echo ""
            if [ -d "simulators/devp2p" ]; then
              echo "‚úì devp2p simulator found"
              ls -la simulators/devp2p/ | head -10
            else
              echo "‚úó devp2p simulator NOT found"
              echo "Trying alternative paths..."
              find . -name "*devp2p*" -type d | grep -i simulator | head -5
            fi
          else
            echo "‚úó Simulators directory does not exist!"
            echo "Current directory structure:"
            ls -la | head -20
          fi
          echo ""
          echo "4. Testing Hive help/usage:"
          hive --help 2>&1 | head -20 || echo "Cannot get help"
          echo ""
          echo "5. Testing if Hive can list clients:"
          # Some versions of Hive support listing
          hive --list 2>&1 | head -20 || echo "List command not available or failed"
          echo ""
          echo "6. Current directory and structure:"
          pwd
          ls -la | head -10

      - name: Setup Hive client configuration
        run: |
          mkdir -p /tmp/hive/clients/gethrelay
          # Copy base structure from go-ethereum (this includes all necessary files)
          cp -r /tmp/hive/clients/go-ethereum/* /tmp/hive/clients/gethrelay/
          
          # Create hive.yaml (must match go-ethereum format for Hive compatibility)
          cat > /tmp/hive/clients/gethrelay/hive.yaml << 'EOF'
          roles:
            - "eth1"
          EOF
          
          # Verify we copied all necessary files
          echo "Client files copied:"
          ls -la /tmp/hive/clients/gethrelay/
          
          # Copy and adapt all necessary scripts from go-ethereum
          if [ -f /tmp/hive/clients/gethrelay/geth.sh ]; then
            cp /tmp/hive/clients/gethrelay/geth.sh /tmp/hive/clients/gethrelay/gethrelay.sh
            sed -i 's/geth/gethrelay/g' /tmp/hive/clients/gethrelay/gethrelay.sh
          else
            cat > /tmp/hive/clients/gethrelay/gethrelay.sh << 'SCRIPTEOF'
          #!/bin/sh
          exec gethrelay --chain mainnet --rpc.upstream https://ethereum-rpc.publicnode.com
          SCRIPTEOF
            chmod +x /tmp/hive/clients/gethrelay/gethrelay.sh
          fi
          
          # Create/adapt enode.sh script (required by Hive for P2P tests)
          if [ -f /tmp/hive/clients/gethrelay/enode.sh ]; then
            sed -i 's/geth/gethrelay/g' /tmp/hive/clients/gethrelay/enode.sh
          else
            cat > /tmp/hive/clients/gethrelay/enode.sh << 'ENODEEOF'
          #!/bin/sh
          # Output the enode URL for P2P connectivity
          exec gethrelay --exec "admin.nodeInfo.enode" attach
          ENODEEOF
            chmod +x /tmp/hive/clients/gethrelay/enode.sh
          fi
          
          # Ensure all copied scripts are adapted for gethrelay
          find /tmp/hive/clients/gethrelay -type f -name "*.sh" | while read script; do
            if grep -q "geth" "$script" 2>/dev/null; then
              sed -i 's/\bgeth\b/gethrelay/g' "$script"
            fi
          done
          
          # Create Dockerfile.local that uses our image
          # Must match go-ethereum structure for Hive compatibility
          # Build context will be /tmp/hive/clients/gethrelay
          cat > /tmp/hive/clients/gethrelay/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          # Switch to root to install packages (base image runs as non-root user)
          USER root
          RUN apk add --update --no-cache bash curl jq
          # Copy all necessary scripts
          COPY gethrelay.sh /gethrelay.sh
          COPY enode.sh /enode.sh
          # Copy mapper.jq (should exist since we copied from go-ethereum)
          COPY mapper.jq /mapper.jq
          RUN chmod +x /gethrelay.sh /enode.sh
          # Switch back to gethrelay user
          USER gethrelay
          EXPOSE 8545 30303 30303/udp
          ENTRYPOINT ["/gethrelay.sh"]
          EOF
          
          # Verify client directory structure
          echo "Client directory contents:"
          ls -la /tmp/hive/clients/gethrelay/
          
      - name: Verify base image exists
        run: |
          echo "Checking if base ethereum/gethrelay:latest exists..."
          docker images | grep gethrelay
          docker inspect ethereum/gethrelay:latest || (echo "ERROR: Base image not found" && exit 1)
          
      - name: Build Hive client image
        working-directory: /tmp/hive/clients/gethrelay
        run: |
          echo "Building Hive client image from Dockerfile.local..."
          docker build -f Dockerfile.local -t hive/clients/gethrelay:local .
          echo "Verifying image was built..."
          docker images | grep gethrelay
          docker inspect hive/clients/gethrelay:local || (echo "ERROR: Failed to build client image" && exit 1)

      - name: Verify client discovery
        working-directory: /tmp/hive
        run: |
          echo "Checking client directory structure..."
          ls -la clients/gethrelay/
          echo ""
          echo "Checking hive.yaml..."
          cat clients/gethrelay/hive.yaml
          echo ""
          echo "Listing available clients..."
          ls -d clients/*/
          echo ""
          echo "Comparing with go-ethereum client..."
          ls -la clients/go-ethereum/ | head -20

      - name: Debug - Comprehensive client discovery analysis
        working-directory: /tmp/hive
        run: |
          echo "=== COMPREHENSIVE CLIENT DISCOVERY DEBUG ==="
          echo ""
          echo "1. Checking if clients/gethrelay directory exists:"
          test -d clients/gethrelay && echo "  ‚úì Directory exists" || echo "  ‚úó Directory NOT found"
          echo ""
          echo "2. Listing all client directories:"
          ls -d clients/*/ | sed 's|^|  |'
          echo ""
          echo "3. Files in gethrelay directory:"
          ls -la clients/gethrelay/ 2>/dev/null | sed 's|^|  |' || echo "  ‚úó Cannot list directory"
          echo ""
          echo "4. Checking critical files:"
          for file in hive.yaml Dockerfile.local gethrelay.sh enode.sh; do
            if [ -f "clients/gethrelay/$file" ]; then
              echo "  ‚úì $file exists"
              if [ "$file" = "hive.yaml" ]; then
                echo "    Content:"
                cat clients/gethrelay/$file | sed 's|^|      |'
              fi
            else
              echo "  ‚úó $file MISSING"
            fi
          done
          echo ""
          echo "5. Comparing with go-ethereum structure:"
          echo "  go-ethereum files:"
          ls clients/go-ethereum/ | head -10 | sed 's|^|    |'
          echo ""
          echo "6. Checking if Hive needs clients directory to be in specific location:"
          pwd
          echo "  Current working directory"
          echo ""
          echo "7. Testing Docker build of client manually:"
          cd clients/gethrelay
          if docker build -f Dockerfile.local -t test-gethrelay:local . 2>&1 | tail -15; then
            echo "  ‚úì Docker build succeeded"
            docker rmi test-gethrelay:local || true
          else
            echo "  ‚úó Docker build failed"
          fi
          cd ../..
          echo ""
          echo "8. Looking for client registry or discovery mechanism:"
          # Hive might cache client list or have a registry
          find . -name "*client*" -type f | grep -E "(yaml|yml|json|toml)" | head -5 | sed 's|^|  |' || echo "  No obvious client registry found"
          echo ""
          echo "9. Checking Hive binary for client discovery logic:"
          strings hive 2>/dev/null | grep -i "client" | head -3 | sed 's|^|  |' || echo "  Cannot inspect binary"
          echo ""
          echo "=== END DEBUG ==="

      - name: Try gethrelay:local first, then fallback to go-ethereum
        working-directory: /tmp/hive
        run: |
          echo "=== Attempt 1: Using gethrelay:local ==="
          echo ""
          echo "Verifying client setup:"
          echo "  - Client image exists:"
          docker images | grep gethrelay || echo "    ‚úó No gethrelay images found"
          echo "  - Client directory:"
          ls -la clients/gethrelay/ 2>/dev/null | head -5 || echo "    ‚úó Directory not found"
          echo ""
          
          # Set results directory
          RESULTS_DIR="./test-results-rpc"
          mkdir -p "$RESULTS_DIR"
          
          # Try gethrelay:local first
          if hive --sim=ethereum/rpc \
                  --client=gethrelay:local \
                  --loglevel=5 \
                  --sim.timelimit=15m \
                  --results-root="$RESULTS_DIR" 2>&1 | tee /tmp/hive-gethrelay-test.log; then
            echo "‚úì gethrelay:local succeeded!"
            echo ""
            echo "Results saved to: $RESULTS_DIR"
            find "$RESULTS_DIR" -type f | head -10
            exit 0
          else
            echo ""
            echo "‚úó gethrelay:local failed - checking error:"
            grep -i "unknown client" /tmp/hive-gethrelay-test.log || echo "  Error not related to client discovery"
            echo ""
            echo "=== Attempt 2: Workaround using go-ethereum:local ==="
            echo ""
            echo "Using go-ethereum client structure but with gethrelay image"
            echo "This is a workaround until we fix client discovery"
            echo ""
            
            # Modify go-ethereum Dockerfile.local to use our image
            cp clients/go-ethereum/Dockerfile.local clients/go-ethereum/Dockerfile.local.backup
            cat > clients/go-ethereum/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          USER root
          RUN apk add --update --no-cache bash curl jq
          COPY geth.sh /geth.sh
          COPY enode.sh /hive-bin/enode.sh
          COPY mapper.jq /mapper.jq
          RUN chmod +x /geth.sh /hive-bin/enode.sh
          USER gethrelay
          EXPOSE 8545 8546 8547 8551 30303 30303/udp
          ENTRYPOINT ["/geth.sh"]
          EOF
            
            # Adapt geth.sh to use gethrelay
            sed -i 's|exec geth|exec gethrelay|g' clients/go-ethereum/geth.sh
            
            # Set results directory for fallback
            RESULTS_DIR="./test-results"
            mkdir -p "$RESULTS_DIR"
            
            echo "Running Hive with go-ethereum:local (using gethrelay)..."
            echo "Results will be saved to: $RESULTS_DIR"
            echo "Absolute path: $(realpath "$RESULTS_DIR" || pwd)/$RESULTS_DIR"
            echo ""
            
            # Run Hive and capture all output
            set +e  # Don't exit on error so we can inspect results
            hive --sim=ethereum/rpc \
                 --client=go-ethereum:local \
                 --loglevel=5 \
                 --sim.timelimit=15m \
                 --results-root="$RESULTS_DIR" 2>&1 | tee /tmp/hive-goethereum-test.log
            HIVE_EXIT_CODE=$?
            set -e
            
            echo ""
            echo "Hive exit code: $HIVE_EXIT_CODE"
            echo ""
            
            # Check what was created
            echo "=== Checking results directory ==="
            if [ -d "$RESULTS_DIR" ]; then
              echo "Directory exists: $RESULTS_DIR"
              echo "Contents:"
              ls -la "$RESULTS_DIR" || echo "Cannot list directory"
              echo ""
              echo "All files:"
              find "$RESULTS_DIR" -type f || echo "No files found"
            else
              echo "Directory does not exist: $RESULTS_DIR"
            fi
            
            # Check workspace/logs (Hive default)
            if [ -d "workspace/logs" ]; then
              echo ""
              echo "=== Checking workspace/logs ==="
              find workspace/logs -type f | head -20
            fi
            
            # Check for any log files
            echo ""
            echo "=== All .log files in current directory ==="
            find . -name "*.log" -type f 2>/dev/null | head -10 || echo "No log files"
            
            # Always show the full output to understand what happened
            echo ""
            echo "=== Full Hive Output ==="
            cat /tmp/hive-goethereum-test.log
            echo ""
            echo "=== Output Analysis ==="
            
            # Check for common issues
            if grep -qi "unknown client\|client.*not found" /tmp/hive-goethereum-test.log; then
              echo "‚ùå ISSUE: Client not recognized by Hive"
            fi
            if grep -qi "simulator.*not found\|no.*simulator" /tmp/hive-goethereum-test.log; then
              echo "‚ùå ISSUE: Simulator not found"
            fi
            if grep -qi "error\|failed\|fatal" /tmp/hive-goethereum-test.log; then
              echo "‚ùå ISSUE: Errors detected in output"
              grep -i "error\|failed\|fatal" /tmp/hive-goethereum-test.log | head -10
            fi
            if grep -qi "simulator.*started\|running.*test" /tmp/hive-goethereum-test.log; then
              echo "‚úì Simulators appear to have started"
            fi
            
            # If exit code is non-zero, show error
            if [ $HIVE_EXIT_CODE -ne 0 ]; then
              echo ""
              echo "‚ùå Hive exited with error code: $HIVE_EXIT_CODE"
              echo ""
              echo "Last 50 lines of output:"
              tail -50 /tmp/hive-goethereum-test.log
            else
              echo ""
              echo "‚úì Hive exited successfully (code: $HIVE_EXIT_CODE)"
            fi
            
            # Check if we should exit based on whether results exist
            if [ ! -d "$RESULTS_DIR" ] || [ -z "$(find "$RESULTS_DIR" -type f 2>/dev/null)" ]; then
              echo ""
              echo "‚ö†Ô∏è WARNING: No results found after test completion"
              echo "This may indicate tests didn't run or no simulators were found"
              echo ""
              echo "Checking available simulators..."
              echo "Simulators directory:"
              ls -la simulators/ 2>/dev/null | head -10 || echo "Simulators directory not found"
            fi
          fi
        continue-on-error: false

      - name: Run devp2p tests
        working-directory: /tmp/hive
        run: |
          echo "=== Running devp2p tests ==="
          echo ""
          
          # Set results directory
          RESULTS_DIR="./test-results-devp2p"
          mkdir -p "$RESULTS_DIR"
          
          # Try gethrelay:local first, fallback to go-ethereum:local if needed
          if hive --sim=devp2p \
                  --client=gethrelay:local \
                  --loglevel=5 \
                  --sim.timelimit=15m \
                  --results-root="$RESULTS_DIR" 2>&1 | tee /tmp/hive-devp2p-test.log; then
            echo "‚úì gethrelay:local succeeded for devp2p!"
            echo ""
            echo "Results saved to: $RESULTS_DIR"
            find "$RESULTS_DIR" -type f | head -10
            exit 0
          else
            echo ""
            echo "‚úó gethrelay:local failed for devp2p - using go-ethereum:local workaround"
            echo ""
            
            # Ensure go-ethereum is configured for gethrelay (from RPC test step)
            # If not already done, set it up
            if [ ! -f clients/go-ethereum/Dockerfile.local.backup ]; then
              echo "Setting up go-ethereum workaround..."
              cp clients/go-ethereum/Dockerfile.local clients/go-ethereum/Dockerfile.local.backup
              cat > clients/go-ethereum/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          USER root
          RUN apk add --update --no-cache bash curl jq
          COPY geth.sh /geth.sh
          COPY enode.sh /hive-bin/enode.sh
          COPY mapper.jq /mapper.jq
          RUN chmod +x /geth.sh /hive-bin/enode.sh
          USER gethrelay
          EXPOSE 8545 8546 8547 8551 30303 30303/udp
          ENTRYPOINT ["/geth.sh"]
          EOF
              sed -i 's|exec geth|exec gethrelay|g' clients/go-ethereum/geth.sh
            fi
            
            # Set results directory for fallback
            RESULTS_DIR="./test-results"
            mkdir -p "$RESULTS_DIR"
            
            echo "Running Hive with go-ethereum:local (using gethrelay)..."
            if hive --sim=devp2p \
                    --client=go-ethereum:local \
                    --loglevel=5 \
                    --sim.timelimit=15m \
                    --results-root="$RESULTS_DIR" 2>&1 | tee /tmp/hive-devp2p-goethereum.log; then
              echo ""
              echo "‚úì Tests completed successfully!"
              echo "Results saved to: $RESULTS_DIR"
              find "$RESULTS_DIR" -type f | head -10
              echo ""
              echo "Directory structure:"
              ls -laR "$RESULTS_DIR" | head -30
            else
              echo "‚úó Tests failed"
              echo "Last 50 lines of log:"
              tail -50 /tmp/hive-devp2p-goethereum.log
              exit 1
            fi
          fi
        continue-on-error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hive-test-results
          path: |
            /tmp/hive/test-results*
            /tmp/hive/test-results*/**
            /tmp/hive/**/*.log
            /tmp/hive/workspace/logs/**
          retention-days: 7
          if-no-files-found: warn
          compression-level: 0

      - name: Test summary
        if: always()
        working-directory: /tmp/hive
        run: |
          echo "## Hive Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find all test result directories
          echo "=== Searching for test results ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "All test-results directories:"
          find . -type d -name "test-results*" 2>/dev/null | head -20
          echo ""
          echo "All simulator.log files:"
          find . -name "simulator.log" 2>/dev/null | head -20
          echo ""
          echo "All .log files:"
          find . -name "*.log" -type f 2>/dev/null | head -20
          echo ""
          
          # Check workspace directory (Hive default)
          if [ -d "workspace/logs" ]; then
            echo "Found Hive workspace/logs directory"
            find workspace/logs -type f | head -10
          fi
          echo ""
          
          # Check RPC test results in multiple locations
          echo "### RPC Tests" >> $GITHUB_STEP_SUMMARY
          RPC_RESULTS=""
          for dir in "./test-results-rpc" "./test-results" "workspace/logs"; do
            if [ -d "$dir" ]; then
              RESULT_FILE=$(find "$dir" -name "simulator.log" -type f 2>/dev/null | head -1)
              if [ -n "$RESULT_FILE" ] && [ -f "$RESULT_FILE" ]; then
                RPC_RESULTS="$RESULT_FILE"
                break
              fi
            fi
          done
          
          if [ -n "$RPC_RESULTS" ] && [ -f "$RPC_RESULTS" ]; then
            echo "Found RPC results at: $RPC_RESULTS" >> $GITHUB_STEP_SUMMARY
            PASSED=$(grep -c "pass=true" "$RPC_RESULTS" 2>/dev/null || echo "0")
            FAILED=$(grep -c "pass=false" "$RPC_RESULTS" 2>/dev/null || echo "0")
            TOTAL=$(grep -c "pass=" "$RPC_RESULTS" 2>/dev/null || echo "0")
            echo "- Total: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            if [ "$TOTAL" -gt 0 ]; then
              echo "‚úÖ Tests completed" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Log file exists but no pass/fail entries found" >> $GITHUB_STEP_SUMMARY
              echo "Sample log content:" >> $GITHUB_STEP_SUMMARY
              head -20 "$RPC_RESULTS" | sed 's/^/  /' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå No RPC test results found" >> $GITHUB_STEP_SUMMARY
            echo "Searched in: test-results-rpc, test-results, workspace/logs" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check devp2p test results in multiple locations
          echo "### devp2p Tests" >> $GITHUB_STEP_SUMMARY
          DEVP2P_RESULTS=""
          for dir in "./test-results-devp2p" "./test-results" "workspace/logs"; do
            if [ -d "$dir" ]; then
              RESULT_FILE=$(find "$dir" -name "simulator.log" -type f 2>/dev/null | head -1)
              if [ -n "$RESULT_FILE" ] && [ -f "$RESULT_FILE" ]; then
                DEVP2P_RESULTS="$RESULT_FILE"
                break
              fi
            fi
          done
          
          if [ -n "$DEVP2P_RESULTS" ] && [ -f "$DEVP2P_RESULTS" ]; then
            echo "Found devp2p results at: $DEVP2P_RESULTS" >> $GITHUB_STEP_SUMMARY
            PASSED=$(grep -c "pass=true" "$DEVP2P_RESULTS" 2>/dev/null || echo "0")
            FAILED=$(grep -c "pass=false" "$DEVP2P_RESULTS" 2>/dev/null || echo "0")
            TOTAL=$(grep -c "pass=" "$DEVP2P_RESULTS" 2>/dev/null || echo "0")
            echo "- Total: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            if [ "$TOTAL" -gt 0 ]; then
              echo "‚úÖ Tests completed" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Log file exists but no pass/fail entries found" >> $GITHUB_STEP_SUMMARY
              echo "Sample log content:" >> $GITHUB_STEP_SUMMARY
              head -20 "$DEVP2P_RESULTS" | sed 's/^/  /' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå No devp2p test results found" >> $GITHUB_STEP_SUMMARY
            echo "Searched in: test-results-devp2p, test-results, workspace/logs" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show any available log files
          echo "### Available Log Files" >> $GITHUB_STEP_SUMMARY
          LOG_COUNT=$(find . -name "*.log" -type f 2>/dev/null | wc -l)
          if [ "$LOG_COUNT" -gt 0 ]; then
            find . -name "*.log" -type f 2>/dev/null | head -15 | while read logfile; do
              SIZE=$(du -h "$logfile" 2>/dev/null | cut -f1)
              echo "- \`$logfile\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "No log files found" >> $GITHUB_STEP_SUMMARY
          fi

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: success() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (success)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ‚úÖ *gethrelay CI Passed*
            
            All tests completed successfully!
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: failure() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (failure)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ‚ùå *gethrelay CI Failed*
            
            Some tests or builds failed. Please check the logs.
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

