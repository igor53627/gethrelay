name: Gethrelay Tests

on:
  push:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  notify-start:
    name: Notify Start
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false'
    steps:
      - name: Send Telegram notification (workflow started)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            üöÄ *gethrelay CI Started*
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            *Author:* ${{ github.actor }}
            *Workflow:* ${{ github.workflow }}
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [notify-start]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Run unit tests
        working-directory: ./cmd/gethrelay
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic .

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./cmd/gethrelay/coverage.out
          flags: gethrelay
          name: gethrelay-coverage

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [unit-tests]
    outputs:
      image: ${{ steps.meta.outputs.tags }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ethereum/gethrelay
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=gethrelay-$(git rev-parse HEAD:cmd/gethrelay/Dockerfile.gethrelay)-$(git rev-parse HEAD:go.mod)-$(git rev-parse HEAD:go.sum)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          file: ./cmd/gethrelay/Dockerfile.gethrelay
          push: false
          tags: ethereum/gethrelay:latest,ethereum/gethrelay:${{ github.sha }}
          load: true
          cache-from: |
            type=gha,scope=gethrelay-deps
            type=gha,scope=gethrelay-builder
            type=gha,scope=gethrelay
          cache-to: |
            type=gha,mode=max,scope=gethrelay-deps
            type=gha,mode=max,scope=gethrelay-builder
            type=gha,mode=max,scope=gethrelay
          build-args: |
            GO_VERSION=${{ env.GO_VERSION }}
            COMMIT=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            BUILDNUM=${{ github.run_number }}
          platforms: linux/amd64

      - name: Verify image exists
        run: |
          docker images | grep gethrelay
          docker inspect ethereum/gethrelay:latest

      - name: Save image
        run: |
          docker save ethereum/gethrelay:latest -o /tmp/gethrelay-image.tar
          gzip -f /tmp/gethrelay-image.tar
          ls -lh /tmp/gethrelay-image.tar.gz
          file /tmp/gethrelay-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp/gethrelay-image.tar.gz
          retention-days: 1
          compression-level: 0

  hive-tests:
    name: Hive Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp

      - name: Load Docker image
        run: |
          echo "Checking downloaded file..."
          ls -lh /tmp/gethrelay-image.tar.gz
          echo "Loading Docker image..."
          gunzip -c /tmp/gethrelay-image.tar.gz | docker load || {
            echo "Error loading image, trying alternative method..."
            gunzip /tmp/gethrelay-image.tar.gz
            docker load -i /tmp/gethrelay-image.tar
          }
          echo "Verifying image loaded..."
          docker images | grep gethrelay

      - name: Set up Hive
        run: |
          git clone --depth=1 https://github.com/ethereum/hive.git /tmp/hive
          cd /tmp/hive && go build -o /usr/local/bin/hive .

      - name: Setup Hive client configuration
        run: |
          mkdir -p /tmp/hive/clients/gethrelay
          # Copy base structure from go-ethereum (this includes all necessary files)
          cp -r /tmp/hive/clients/go-ethereum/* /tmp/hive/clients/gethrelay/
          
          # Create hive.yaml (must match go-ethereum format for Hive compatibility)
          cat > /tmp/hive/clients/gethrelay/hive.yaml << 'EOF'
          roles:
            - "eth1"
          EOF
          
          # Verify we copied all necessary files
          echo "Client files copied:"
          ls -la /tmp/hive/clients/gethrelay/
          
          # Copy and adapt all necessary scripts from go-ethereum
          if [ -f /tmp/hive/clients/gethrelay/geth.sh ]; then
            cp /tmp/hive/clients/gethrelay/geth.sh /tmp/hive/clients/gethrelay/gethrelay.sh
            sed -i 's/geth/gethrelay/g' /tmp/hive/clients/gethrelay/gethrelay.sh
          else
            cat > /tmp/hive/clients/gethrelay/gethrelay.sh << 'SCRIPTEOF'
          #!/bin/sh
          exec gethrelay --chain mainnet --rpc.upstream https://ethereum-rpc.publicnode.com
          SCRIPTEOF
            chmod +x /tmp/hive/clients/gethrelay/gethrelay.sh
          fi
          
          # Create/adapt enode.sh script (required by Hive for P2P tests)
          if [ -f /tmp/hive/clients/gethrelay/enode.sh ]; then
            sed -i 's/geth/gethrelay/g' /tmp/hive/clients/gethrelay/enode.sh
          else
            cat > /tmp/hive/clients/gethrelay/enode.sh << 'ENODEEOF'
          #!/bin/sh
          # Output the enode URL for P2P connectivity
          exec gethrelay --exec "admin.nodeInfo.enode" attach
          ENODEEOF
            chmod +x /tmp/hive/clients/gethrelay/enode.sh
          fi
          
          # Ensure all copied scripts are adapted for gethrelay
          find /tmp/hive/clients/gethrelay -type f -name "*.sh" | while read script; do
            if grep -q "geth" "$script" 2>/dev/null; then
              sed -i 's/\bgeth\b/gethrelay/g' "$script"
            fi
          done
          
          # Create Dockerfile.local that uses our image
          # Must match go-ethereum structure for Hive compatibility
          # Build context will be /tmp/hive/clients/gethrelay
          cat > /tmp/hive/clients/gethrelay/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          # Switch to root to install packages (base image runs as non-root user)
          USER root
          RUN apk add --update --no-cache bash curl jq
          # Copy all necessary scripts
          COPY gethrelay.sh /gethrelay.sh
          COPY enode.sh /enode.sh
          RUN chmod +x /gethrelay.sh /enode.sh
          # Copy mapper.jq if it exists (used by some simulators)
          COPY mapper.jq /mapper.jq 2>/dev/null || true
          # Switch back to gethrelay user
          USER gethrelay
          EXPOSE 8545 30303 30303/udp
          ENTRYPOINT ["/gethrelay.sh"]
          EOF
          
          # Verify client directory structure
          echo "Client directory contents:"
          ls -la /tmp/hive/clients/gethrelay/
          
      - name: Verify base image exists
        run: |
          echo "Checking if base ethereum/gethrelay:latest exists..."
          docker images | grep gethrelay
          docker inspect ethereum/gethrelay:latest || (echo "ERROR: Base image not found" && exit 1)
          
      - name: Build Hive client image
        working-directory: /tmp/hive/clients/gethrelay
        run: |
          echo "Building Hive client image from Dockerfile.local..."
          docker build -f Dockerfile.local -t hive/clients/gethrelay:local .
          echo "Verifying image was built..."
          docker images | grep gethrelay
          docker inspect hive/clients/gethrelay:local || (echo "ERROR: Failed to build client image" && exit 1)

      - name: Verify client discovery
        working-directory: /tmp/hive
        run: |
          echo "Checking client directory structure..."
          ls -la clients/gethrelay/
          echo ""
          echo "Checking hive.yaml..."
          cat clients/gethrelay/hive.yaml
          echo ""
          echo "Listing available clients..."
          ls -d clients/*/
          echo ""
          echo "Comparing with go-ethereum client..."
          ls -la clients/go-ethereum/ | head -20

      - name: Debug - Comprehensive client discovery analysis
        working-directory: /tmp/hive
        run: |
          echo "=== COMPREHENSIVE CLIENT DISCOVERY DEBUG ==="
          echo ""
          echo "1. Checking if clients/gethrelay directory exists:"
          test -d clients/gethrelay && echo "  ‚úì Directory exists" || echo "  ‚úó Directory NOT found"
          echo ""
          echo "2. Listing all client directories:"
          ls -d clients/*/ | sed 's|^|  |'
          echo ""
          echo "3. Files in gethrelay directory:"
          ls -la clients/gethrelay/ 2>/dev/null | sed 's|^|  |' || echo "  ‚úó Cannot list directory"
          echo ""
          echo "4. Checking critical files:"
          for file in hive.yaml Dockerfile.local gethrelay.sh enode.sh; do
            if [ -f "clients/gethrelay/$file" ]; then
              echo "  ‚úì $file exists"
              if [ "$file" = "hive.yaml" ]; then
                echo "    Content:"
                cat clients/gethrelay/$file | sed 's|^|      |'
              fi
            else
              echo "  ‚úó $file MISSING"
            fi
          done
          echo ""
          echo "5. Comparing with go-ethereum structure:"
          echo "  go-ethereum files:"
          ls clients/go-ethereum/ | head -10 | sed 's|^|    |'
          echo ""
          echo "6. Checking if Hive needs clients directory to be in specific location:"
          pwd
          echo "  Current working directory"
          echo ""
          echo "7. Testing Docker build of client manually:"
          cd clients/gethrelay
          if docker build -f Dockerfile.local -t test-gethrelay:local . 2>&1 | tail -15; then
            echo "  ‚úì Docker build succeeded"
            docker rmi test-gethrelay:local || true
          else
            echo "  ‚úó Docker build failed"
          fi
          cd ../..
          echo ""
          echo "8. Looking for client registry or discovery mechanism:"
          # Hive might cache client list or have a registry
          find . -name "*client*" -type f | grep -E "(yaml|yml|json|toml)" | head -5 | sed 's|^|  |' || echo "  No obvious client registry found"
          echo ""
          echo "9. Checking Hive binary for client discovery logic:"
          strings hive 2>/dev/null | grep -i "client" | head -3 | sed 's|^|  |' || echo "  Cannot inspect binary"
          echo ""
          echo "=== END DEBUG ==="

      - name: Run RPC tests
        working-directory: /tmp/hive
        run: |
          echo "=== Running RPC tests with gethrelay:local ==="
          echo ""
          echo "Verifying client setup before running tests:"
          echo "  - Client image exists:"
          docker images | grep gethrelay || echo "    ‚úó No gethrelay images found"
          echo "  - Client directory:"
          ls -la clients/gethrelay/ 2>/dev/null | head -5 || echo "    ‚úó Directory not found"
          echo ""
          echo "Running Hive RPC tests..."
          hive --sim=ethereum/rpc \
               --client=gethrelay:local \
               --loglevel=5 \
               --sim.timelimit=15m \
               --results-root=./test-results
        continue-on-error: false

      - name: Run devp2p tests
        working-directory: /tmp/hive
        run: |
          hive --sim=devp2p \
               --client=gethrelay:local \
               --loglevel=3 \
               --sim.timelimit=15m \
               --results-root=./test-results
        continue-on-error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hive-test-results
          path: /tmp/hive/test-results
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo "## Hive Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RPC Tests" >> $GITHUB_STEP_SUMMARY
          grep -c "pass=true" /tmp/hive/test-results/*/simulator.log || echo "No results found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### devp2p Tests" >> $GITHUB_STEP_SUMMARY
          grep -c "pass=true" /tmp/hive/test-results/*/simulator.log || echo "No results found" >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: success() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (success)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ‚úÖ *gethrelay CI Passed*
            
            All tests completed successfully!
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: failure() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (failure)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ‚ùå *gethrelay CI Failed*
            
            Some tests or builds failed. Please check the logs.
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

