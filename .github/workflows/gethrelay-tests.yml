name: Gethrelay Tests

on:
  push:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'cmd/gethrelay/**'
      - 'eth/relay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-tests.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  notify-start:
    name: Notify Start
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false'
    steps:
      - name: Send Telegram notification (workflow started)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ðŸš€ *gethrelay CI Started*
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            *Author:* ${{ github.actor }}
            *Workflow:* ${{ github.workflow }}
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [notify-start]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Run unit tests
        working-directory: ./cmd/gethrelay
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic .

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./cmd/gethrelay/coverage.out
          flags: gethrelay
          name: gethrelay-coverage

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [unit-tests]
    outputs:
      image: ${{ steps.meta.outputs.tags }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ethereum/gethrelay
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Generate cache key
        id: cache-key
        run: |
          # More granular cache key based on actual file content hashes
          DOCKERFILE_HASH=$(git hash-object cmd/gethrelay/Dockerfile.gethrelay 2>/dev/null || sha256sum cmd/gethrelay/Dockerfile.gethrelay | cut -d' ' -f1)
          GOMOD_HASH=$(git hash-object go.mod 2>/dev/null || sha256sum go.mod | cut -d' ' -f1)
          GOSUM_HASH=$(git hash-object go.sum 2>/dev/null || sha256sum go.sum | cut -d' ' -f1)
          echo "key=gethrelay-${DOCKERFILE_HASH}-${GOMOD_HASH}-${GOSUM_HASH}" >> $GITHUB_OUTPUT
          echo "dockerfile-hash=${DOCKERFILE_HASH}" >> $GITHUB_OUTPUT
          echo "gomod-hash=${GOMOD_HASH}" >> $GITHUB_OUTPUT
          echo "gosum-hash=${GOSUM_HASH}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          file: ./cmd/gethrelay/Dockerfile.gethrelay
          push: false
          tags: ethereum/gethrelay:latest,ethereum/gethrelay:${{ github.sha }}
          load: true
          cache-from: |
            type=gha,scope=gethrelay-deps-${{ steps.cache-key.outputs.gomod-hash }}-${{ steps.cache-key.outputs.gosum-hash }}
            type=gha,scope=gethrelay-deps
            type=gha,mode=max,scope=gethrelay-builder-${{ steps.cache-key.outputs.dockerfile-hash }}
            type=gha,mode=max,scope=gethrelay-builder
            type=gha,mode=max,scope=gethrelay
          cache-to: |
            type=gha,mode=max,scope=gethrelay-deps-${{ steps.cache-key.outputs.gomod-hash }}-${{ steps.cache-key.outputs.gosum-hash }}
            type=gha,mode=max,scope=gethrelay-deps
            type=gha,mode=max,scope=gethrelay-builder-${{ steps.cache-key.outputs.dockerfile-hash }}
            type=gha,mode=max,scope=gethrelay-builder
            type=gha,mode=max,scope=gethrelay
          build-args: |
            GO_VERSION=${{ env.GO_VERSION }}
            COMMIT=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            BUILDNUM=${{ github.run_number }}
          platforms: linux/amd64

      - name: Verify image exists
        run: |
          docker images | grep gethrelay
          docker inspect ethereum/gethrelay:latest

      - name: Save image
        run: |
          docker save ethereum/gethrelay:latest -o /tmp/gethrelay-image.tar
          gzip -f /tmp/gethrelay-image.tar
          ls -lh /tmp/gethrelay-image.tar.gz
          file /tmp/gethrelay-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp/gethrelay-image.tar.gz
          retention-days: 1
          compression-level: 0

  hive-tests:
    name: Hive Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: gethrelay-image
          path: /tmp

      - name: Load Docker image
        run: |
          echo "Checking downloaded file..."
          ls -lh /tmp/gethrelay-image.tar.gz
          echo "Loading Docker image..."
          gunzip -c /tmp/gethrelay-image.tar.gz | docker load || {
            echo "Error loading image, trying alternative method..."
            gunzip /tmp/gethrelay-image.tar.gz
            docker load -i /tmp/gethrelay-image.tar
          }
          echo "Verifying image loaded..."
          docker images | grep gethrelay

      - name: Cache Hive binary
        uses: actions/cache@v4
        id: hive-cache
        with:
          path: /tmp/hive-binary
          key: hive-${{ runner.os }}-${{ hashFiles('.github/workflows/gethrelay-tests.yml') }}
          restore-keys: |
            hive-${{ runner.os }}-

      - name: Set up Hive
        run: |
          # Always clone Hive repository (needed for simulators and client configs)
          echo "Cloning Hive repository..."
          git clone --depth=1 https://github.com/ethereum/hive.git /tmp/hive
          
          # Use cached binary if available, otherwise build it
          if [ -f "/tmp/hive-binary/hive" ]; then
            echo "Using cached Hive binary"
            cp /tmp/hive-binary/hive /usr/local/bin/hive
          else
            echo "Building Hive from source"
            cd /tmp/hive && go build -o /usr/local/bin/hive .
            mkdir -p /tmp/hive-binary
            cp /usr/local/bin/hive /tmp/hive-binary/hive
          fi
          
          # Verify Hive is set up correctly
          echo "Verifying Hive setup..."
          /usr/local/bin/hive --version || echo "Hive version check failed"
          test -d /tmp/hive/simulators || (echo "ERROR: Simulators directory not found!" && exit 1)
          test -d /tmp/hive/clients || (echo "ERROR: Clients directory not found!" && exit 1)
          
      - name: Verify workflow file version
        run: |
          echo "=== Workflow Version Check ==="
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Branch: $(git branch --show-current)"
          echo "Workflow file last modified:"
          git log -1 --format="%ai %h %s" -- .github/workflows/gethrelay-tests.yml || echo "Cannot get git info"
          echo ""
          echo "Checking for diagnostic steps (should see 'Verify Hive setup' step):"
          grep -c "Verify Hive setup" .github/workflows/gethrelay-tests.yml && echo "âœ“ Diagnostic steps found" || echo "âœ— Diagnostic steps missing"
          echo ""
          
      - name: List all available simulators (non-failing diagnostic)
        working-directory: /tmp/hive
        continue-on-error: true
        run: |
          echo "## ðŸ“‹ Available Simulators Diagnostic" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "=== Complete Simulator Listing ==="
          if [ -d "simulators" ]; then
            echo "âœ“ Simulators directory exists"
            echo "**Simulators Directory:** âœ“ Exists" >> $GITHUB_STEP_SUMMARY
            echo ""
            
            echo "All simulator directories (recursive, max depth 3):"
            ALL_SIMS=$(find simulators -maxdepth 3 -type d 2>/dev/null | grep -v "^simulators$" | sed 's|^simulators/||' | sort | uniq)
            echo "$ALL_SIMS"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**All Available Simulators:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$ALL_SIMS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            echo ""
            echo "Top-level simulators only:"
            TOP_LEVEL=$(ls -d simulators/*/ 2>/dev/null | sed 's|simulators/||' | sed 's|/||' | sort)
            echo "$TOP_LEVEL"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Top-Level Simulators:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$TOP_LEVEL" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ— Simulators directory does not exist!"
            echo "Current directory: $(pwd)"
            echo "Directory contents:"
            ls -la
            echo "âŒ **Simulators Directory:** Does NOT exist!" >> $GITHUB_STEP_SUMMARY
          fi
          echo ""
          
      - name: Verify Hive setup and available simulators
        working-directory: /tmp/hive
        run: |
          echo "## ðŸ” Hive Setup Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "=== Hive Setup Verification ==="
          echo ""
          echo "1. Hive binary location and version:"
          which hive || echo "hive not in PATH"
          HIVE_VERSION=$(/usr/local/bin/hive --version 2>&1 || hive --version 2>&1 || echo "Cannot get version")
          echo "$HIVE_VERSION"
          echo "**Hive Version:** \`$HIVE_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo ""
          
          echo "2. Checking simulators directory:"
          SIMULATOR_FOUND=false
          RPC_FOUND=false
          DEVP2P_FOUND=false
          
          if [ -d "simulators" ]; then
            echo "âœ“ Simulators directory exists"
            echo "**Simulators Directory:** âœ“ Exists" >> $GITHUB_STEP_SUMMARY
            echo "Available simulators (top level):"
            SIMULATORS=$(ls -d simulators/*/ 2>/dev/null | sed 's|simulators/||' | sed 's|/||' | head -20)
            echo "$SIMULATORS"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Top-Level Simulators:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$SIMULATORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "3. Checking for specific simulators:"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Simulator Status:**" >> $GITHUB_STEP_SUMMARY
            RPC_FOUND=false
            DEVP2P_FOUND=false
            
            if [ -d "simulators/ethereum/rpc-compat" ]; then
              echo "âœ“ ethereum/rpc-compat simulator found"
              echo "âœ“ **ethereum/rpc-compat:** Found" >> $GITHUB_STEP_SUMMARY
              ls -la simulators/ethereum/rpc-compat/ | head -10
              RPC_FOUND=true
              SIMULATOR_FOUND=true
            else
              echo "âœ— ethereum/rpc-compat simulator NOT found"
              echo "âŒ **ethereum/rpc-compat:** NOT FOUND" >> $GITHUB_STEP_SUMMARY
              echo "Trying alternative paths..."
              ALTERNATIVES=$(find . -path "*/simulators/*rpc*" -type d 2>/dev/null | head -10)
              if [ -n "$ALTERNATIVES" ]; then
                echo "Alternative RPC paths found:"
                echo "$ALTERNATIVES"
                echo "**Alternative RPC paths found:**" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "$ALTERNATIVES" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              else
                echo "No alternative RPC simulator paths found"
              fi
            fi
            echo ""
            if [ -d "simulators/devp2p" ]; then
              echo "âœ“ devp2p simulator found"
              echo "âœ“ **devp2p:** Found" >> $GITHUB_STEP_SUMMARY
              ls -la simulators/devp2p/ | head -10
              DEVP2P_FOUND=true
              SIMULATOR_FOUND=true
            else
              echo "âœ— devp2p simulator NOT found"
              echo "âŒ **devp2p:** NOT FOUND" >> $GITHUB_STEP_SUMMARY
              echo "Trying alternative paths..."
              ALTERNATIVES=$(find . -path "*/simulators/*devp2p*" -type d 2>/dev/null | head -10)
              if [ -n "$ALTERNATIVES" ]; then
                echo "Alternative devp2p paths found:"
                echo "$ALTERNATIVES"
                echo "**Alternative devp2p paths found:**" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "$ALTERNATIVES" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              else
                echo "No alternative devp2p simulator paths found"
              fi
            fi
            
            # Show what simulators actually exist that might match
            echo ""
            echo "4. Looking for simulators that contain 'rpc' or 'devp2p' in their path:"
            echo "Simulators with 'rpc' in path:"
            find simulators -type d -iname "*rpc*" 2>/dev/null | head -10 || echo "None found"
            echo ""
            echo "Simulators with 'devp2p' or 'p2p' in path:"
            find simulators -type d \( -iname "*devp2p*" -o -iname "*p2p*" \) 2>/dev/null | head -10 || echo "None found"
          else
            echo "âœ— Simulators directory does not exist!"
            echo "âŒ **Simulators Directory:** Does NOT exist!" >> $GITHUB_STEP_SUMMARY
            echo "Current directory structure:"
            ls -la | head -20
          fi
          echo ""
          echo "5. Testing Hive help/usage:"
          HIVE_HELP=$(hive --help 2>&1 | head -20 || echo "Cannot get help")
          echo "$HIVE_HELP"
          echo ""
          echo "6. Testing if Hive can list clients:"
          HIVE_LIST=$(hive --list 2>&1 | head -20 || echo "List command not available or failed")
          echo "$HIVE_LIST"
          echo ""
          echo "7. Current directory and structure:"
          pwd
          ls -la | head -10
          
          # Summary to step summary and fail if simulators not found
          # Need both RPC and devp2p for tests to work
          if [ "$RPC_FOUND" = false ] || [ "$DEVP2P_FOUND" = false ]; then
            SIMULATOR_FOUND=false
          fi
          
          if [ "$SIMULATOR_FOUND" = false ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ CRITICAL ISSUE DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Root Cause: Required Simulators NOT FOUND" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Required simulators status:**" >> $GITHUB_STEP_SUMMARY
            if [ "$RPC_FOUND" = false ]; then
              echo "- âŒ \`ethereum/rpc-compat\` - NOT FOUND" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ“ \`ethereum/rpc-compat\` - Found" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$DEVP2P_FOUND" = false ]; then
              echo "- âŒ \`devp2p\` - NOT FOUND" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ“ \`devp2p\` - Found" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Impact:** Hive cannot run tests without the required simulators." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**All available simulators (for reference):**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            find simulators -maxdepth 3 -type d 2>/dev/null | sed 's|^simulators/||' | grep -v "^$" | sort | head -100 >> $GITHUB_STEP_SUMMARY || echo "Could not list simulators" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Solution:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the list above to find simulators that match \`ethereum/rpc-compat\` and \`devp2p\` functionality" >> $GITHUB_STEP_SUMMARY
            echo "2. Update the \`--sim\` flags in the workflow to use the correct simulator names" >> $GITHUB_STEP_SUMMARY
            echo "3. If simulators don't exist, they may need to be installed separately or use a different Hive version" >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "âŒ FAILING STEP: Required simulators are missing!"
            echo ""
            echo "Check the 'List all available simulators' step above to see what simulators are actually available."
            echo "Then update the workflow to use the correct simulator names."
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ **All required simulators found**" >> $GITHUB_STEP_SUMMARY
            if [ "$RPC_FOUND" = true ]; then
              echo "- âœ“ \`ethereum/rpc-compat\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$DEVP2P_FOUND" = true ]; then
              echo "- âœ“ \`devp2p\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Setup Hive client configuration
        run: |
          mkdir -p /tmp/hive/clients/gethrelay
          # Copy base structure from go-ethereum (this includes all necessary files)
          cp -r /tmp/hive/clients/go-ethereum/* /tmp/hive/clients/gethrelay/
          
          # Create hive.yaml (must match go-ethereum format for Hive compatibility)
          cat > /tmp/hive/clients/gethrelay/hive.yaml << 'EOF'
          roles:
            - "eth1"
          EOF
          
          # Verify we copied all necessary files
          echo "Client files copied:"
          ls -la /tmp/hive/clients/gethrelay/
          
          # Copy and adapt all necessary scripts from go-ethereum
          if [ -f /tmp/hive/clients/gethrelay/geth.sh ]; then
            cp /tmp/hive/clients/gethrelay/geth.sh /tmp/hive/clients/gethrelay/gethrelay.sh
            sed -i 's/geth/gethrelay/g' /tmp/hive/clients/gethrelay/gethrelay.sh
          else
            cat > /tmp/hive/clients/gethrelay/gethrelay.sh << 'SCRIPTEOF'
          #!/bin/sh
          exec gethrelay --chain mainnet --rpc.upstream https://ethereum-rpc.publicnode.com
          SCRIPTEOF
            chmod +x /tmp/hive/clients/gethrelay/gethrelay.sh
          fi
          
          # Create/adapt enode.sh script (required by Hive for P2P tests)
          if [ -f /tmp/hive/clients/gethrelay/enode.sh ]; then
            sed -i 's/geth/gethrelay/g' /tmp/hive/clients/gethrelay/enode.sh
          else
            cat > /tmp/hive/clients/gethrelay/enode.sh << 'ENODEEOF'
          #!/bin/sh
          # Output the enode URL for P2P connectivity
          exec gethrelay --exec "admin.nodeInfo.enode" attach
          ENODEEOF
            chmod +x /tmp/hive/clients/gethrelay/enode.sh
          fi
          
          # Ensure all copied scripts are adapted for gethrelay
          find /tmp/hive/clients/gethrelay -type f -name "*.sh" | while read script; do
            if grep -q "geth" "$script" 2>/dev/null; then
              sed -i 's/\bgeth\b/gethrelay/g' "$script"
            fi
          done
          
          # Create Dockerfile.local that uses our image
          # Must match go-ethereum structure for Hive compatibility
          # Build context will be /tmp/hive/clients/gethrelay
          cat > /tmp/hive/clients/gethrelay/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          # Switch to root to install packages (base image runs as non-root user)
          USER root
          RUN apk add --update --no-cache bash curl jq
          # Copy all necessary scripts
          COPY gethrelay.sh /gethrelay.sh
          COPY enode.sh /enode.sh
          # Copy mapper.jq (should exist since we copied from go-ethereum)
          COPY mapper.jq /mapper.jq
          RUN chmod +x /gethrelay.sh /enode.sh
          # Switch back to gethrelay user
          USER gethrelay
          EXPOSE 8545 30303 30303/udp
          ENTRYPOINT ["/gethrelay.sh"]
          EOF
          
          # Verify client directory structure
          echo "Client directory contents:"
          ls -la /tmp/hive/clients/gethrelay/
          
      - name: Verify base image exists
        run: |
          echo "Checking if base ethereum/gethrelay:latest exists..."
          docker images | grep gethrelay
          docker inspect ethereum/gethrelay:latest || (echo "ERROR: Base image not found" && exit 1)
          
      - name: Build Hive client image
        working-directory: /tmp/hive/clients/gethrelay
        run: |
          echo "Building Hive client image from Dockerfile.local..."
          docker build -f Dockerfile.local -t hive/clients/gethrelay:local .
          echo "Verifying image was built..."
          docker images | grep gethrelay
          docker inspect hive/clients/gethrelay:local || (echo "ERROR: Failed to build client image" && exit 1)

      - name: Verify client discovery
        working-directory: /tmp/hive
        run: |
          echo "Checking client directory structure..."
          ls -la clients/gethrelay/
          echo ""
          echo "Checking hive.yaml..."
          cat clients/gethrelay/hive.yaml
          echo ""
          echo "Listing available clients..."
          ls -d clients/*/
          echo ""
          echo "Comparing with go-ethereum client..."
          ls -la clients/go-ethereum/ | head -20

      - name: Debug - Comprehensive client discovery analysis
        working-directory: /tmp/hive
        run: |
          echo "=== COMPREHENSIVE CLIENT DISCOVERY DEBUG ==="
          echo ""
          echo "1. Checking if clients/gethrelay directory exists:"
          test -d clients/gethrelay && echo "  âœ“ Directory exists" || echo "  âœ— Directory NOT found"
          echo ""
          echo "2. Listing all client directories:"
          ls -d clients/*/ | sed 's|^|  |'
          echo ""
          echo "3. Files in gethrelay directory:"
          ls -la clients/gethrelay/ 2>/dev/null | sed 's|^|  |' || echo "  âœ— Cannot list directory"
          echo ""
          echo "4. Checking critical files:"
          for file in hive.yaml Dockerfile.local gethrelay.sh enode.sh; do
            if [ -f "clients/gethrelay/$file" ]; then
              echo "  âœ“ $file exists"
              if [ "$file" = "hive.yaml" ]; then
                echo "    Content:"
                cat clients/gethrelay/$file | sed 's|^|      |'
              fi
            else
              echo "  âœ— $file MISSING"
            fi
          done
          echo ""
          echo "5. Comparing with go-ethereum structure:"
          echo "  go-ethereum files:"
          ls clients/go-ethereum/ | head -10 | sed 's|^|    |'
          echo ""
          echo "6. Checking if Hive needs clients directory to be in specific location:"
          pwd
          echo "  Current working directory"
          echo ""
          echo "7. Testing Docker build of client manually:"
          cd clients/gethrelay
          if docker build -f Dockerfile.local -t test-gethrelay:local . 2>&1 | tail -15; then
            echo "  âœ“ Docker build succeeded"
            docker rmi test-gethrelay:local || true
          else
            echo "  âœ— Docker build failed"
          fi
          cd ../..
          echo ""
          echo "8. Looking for client registry or discovery mechanism:"
          # Hive might cache client list or have a registry
          find . -name "*client*" -type f | grep -E "(yaml|yml|json|toml)" | head -5 | sed 's|^|  |' || echo "  No obvious client registry found"
          echo ""
          echo "9. Checking Hive binary for client discovery logic:"
          strings hive 2>/dev/null | grep -i "client" | head -3 | sed 's|^|  |' || echo "  Cannot inspect binary"
          echo ""
          echo "=== END DEBUG ==="

      - name: Try gethrelay:local first, then fallback to go-ethereum
        working-directory: /tmp/hive
        run: |
          set -x  # Enable debug output
          echo "=== Attempt 1: Using gethrelay:local ==="
          echo ""
          echo "Verifying client setup:"
          echo "  - Client image exists:"
          docker images | grep gethrelay || echo "    âœ— No gethrelay images found"
          echo "  - Client directory:"
          ls -la clients/gethrelay/ 2>/dev/null | head -5 || echo "    âœ— Directory not found"
          echo ""
          
          # Set results directory
          RESULTS_DIR="./test-results-rpc"
          mkdir -p "$RESULTS_DIR"
          
          # Try gethrelay:local first
          echo "Attempting to run tests with gethrelay:local..."
          echo "This will likely fail with 'unknown client', that's expected"
          set +e  # Don't exit on error so we can try fallback
          hive --sim=ethereum/rpc-compat \
                  --client=gethrelay:local \
                  --loglevel=5 \
                  --sim.timelimit=15m \
                  --results-root="$RESULTS_DIR" > /tmp/hive-gethrelay-test.log 2>&1
          HIVE_EXIT_CODE=$?
          echo "gethrelay:local attempt exit code: $HIVE_EXIT_CODE"
          cat /tmp/hive-gethrelay-test.log
          set -e
          
          if [ $HIVE_EXIT_CODE -eq 0 ]; then
            echo "âœ“ gethrelay:local succeeded! (unexpected but great!)"
            echo ""
            echo "Results saved to: $RESULTS_DIR"
            find "$RESULTS_DIR" -type f | head -10
            exit 0
          fi
          
          # If we get here, gethrelay:local failed - proceed with fallback
          echo ""
          echo "âœ— gethrelay:local failed (exit code: $HIVE_EXIT_CODE) - this is expected"
          echo "Full error output:"
          cat /tmp/hive-gethrelay-test.log
          echo ""
          echo "=== PROCEEDING TO FALLBACK: go-ethereum:local ==="
          echo ""
          echo "This is the workaround - using go-ethereum client structure with gethrelay image"
          echo ""
          
          # Verify go-ethereum client exists before modifying
          if [ ! -d "clients/go-ethereum" ]; then
            echo "âŒ ERROR: clients/go-ethereum directory not found!"
            echo "Available clients:"
            ls -d clients/*/ 2>/dev/null || echo "No clients found"
            exit 1
          fi
          
          echo "Backing up original go-ethereum Dockerfile.local..."
          cp clients/go-ethereum/Dockerfile.local clients/go-ethereum/Dockerfile.local.backup || {
            echo "âš ï¸  No original Dockerfile.local to backup, creating new one"
          }
            cat > clients/go-ethereum/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          USER root
          RUN apk add --update --no-cache bash curl jq
          COPY geth.sh /geth.sh
          COPY enode.sh /hive-bin/enode.sh
          COPY mapper.jq /mapper.jq
          RUN chmod +x /geth.sh /hive-bin/enode.sh
          USER gethrelay
          EXPOSE 8545 8546 8547 8551 30303 30303/udp
          ENTRYPOINT ["/geth.sh"]
          EOF
            
            # Adapt geth.sh to use gethrelay
            sed -i 's|exec geth|exec gethrelay|g' clients/go-ethereum/geth.sh
            
            echo ""
            echo "Building go-ethereum client image for Hive..."
            echo "This is required for Hive to discover and use the client"
            echo ""
            echo "Current directory before build: $(pwd)"
            echo "go-ethereum directory contents:"
            ls -la clients/go-ethereum/ | head -15 || echo "Cannot list directory"
            echo ""
            echo "Dockerfile.local content:"
            head -20 clients/go-ethereum/Dockerfile.local || echo "Cannot read Dockerfile"
            echo ""
            cd clients/go-ethereum
            echo "Building from: $(pwd)"
            echo "Docker build context files:"
            ls -la | head -10
            echo ""
            if ! docker build -f Dockerfile.local -t hive/clients/go-ethereum:local . 2>&1 | tee /tmp/go-ethereum-build.log; then
              echo "âŒ ERROR: Failed to build go-ethereum client image!"
              echo "Build log:"
              cat /tmp/go-ethereum-build.log
              cd ../..
              exit 1
            fi
            cd ../..
            echo "âœ“ Client image built successfully"
            echo "Verifying image exists:"
            docker images | grep -E "hive/clients/go-ethereum:local|go-ethereum.*local" || {
              echo "âš ï¸  Image not found with expected tag, showing all related images:"
              docker images | grep -E "go-ethereum|hive.*client|ethereum" || docker images | head -10
            }
            echo ""
            
            # Set results directory for fallback
            RESULTS_DIR="./test-results"
            mkdir -p "$RESULTS_DIR"
            
            echo "Running Hive with go-ethereum:local (using gethrelay)..."
            echo "Results will be saved to: $RESULTS_DIR"
            echo "Absolute path: $(realpath "$RESULTS_DIR" || pwd)/$RESULTS_DIR"
            echo ""
            
            # Verify client image exists before running
            echo "Verifying client image was built correctly..."
            if ! docker images | grep -E "hive/clients/go-ethereum:local|go-ethereum.*local"; then
              echo "âŒ ERROR: Client image not found! Listing all images:"
              docker images | head -20
              echo ""
              echo "Attempting to list images with 'ethereum' or 'hive' in name:"
              docker images | grep -E "ethereum|hive" || echo "No matching images found"
              exit 1
            fi
            echo "âœ“ Client image found"
            echo ""
            
            # Check if Hive can discover the client
            echo "Checking if Hive can discover clients..."
            hive --list 2>&1 | grep -i "go-ethereum\|client" | head -10 || echo "Hive --list command output (check above)"
            echo ""
            
            # Run Hive and capture all output
            echo "Running Hive tests..."
            set +e  # Don't exit on error so we can inspect results
            hive --sim=ethereum/rpc-compat \
                 --client=go-ethereum:local \
                 --loglevel=5 \
                 --sim.timelimit=15m \
                 --results-root="$RESULTS_DIR" 2>&1 | tee /tmp/hive-goethereum-test.log
            HIVE_EXIT_CODE=$?
            set -e
            
            echo ""
            echo "Hive exit code: $HIVE_EXIT_CODE"
            echo ""
            
            # Check what was created
            echo "=== Checking results directory ==="
            if [ -d "$RESULTS_DIR" ]; then
              echo "Directory exists: $RESULTS_DIR"
              echo "Contents:"
              ls -la "$RESULTS_DIR" || echo "Cannot list directory"
              echo ""
              echo "All files:"
              find "$RESULTS_DIR" -type f || echo "No files found"
            else
              echo "Directory does not exist: $RESULTS_DIR"
            fi
            
            # Check workspace/logs (Hive default)
            if [ -d "workspace/logs" ]; then
              echo ""
              echo "=== Checking workspace/logs ==="
              find workspace/logs -type f | head -20
            fi
            
            # Check for any log files
            echo ""
            echo "=== All .log files in current directory ==="
            find . -name "*.log" -type f 2>/dev/null | head -10 || echo "No log files"
            
            # Always show the full output to understand what happened
            echo ""
            echo "=== Full Hive Output (showing last 200 lines if too long) ==="
            if [ -s /tmp/hive-goethereum-test.log ]; then
              wc -l /tmp/hive-goethereum-test.log
              tail -200 /tmp/hive-goethereum-test.log
            else
              echo "Log file is empty or doesn't exist!"
              ls -la /tmp/hive*.log 2>/dev/null || echo "No log files in /tmp"
            fi
            echo ""
            echo "=== Output Analysis ==="
            
            # Check for common issues
            if grep -qi "unknown client\|client.*not found" /tmp/hive-goethereum-test.log; then
              echo "âŒ ISSUE: Client not recognized by Hive"
            fi
            if grep -qi "simulator.*not found\|no.*simulator" /tmp/hive-goethereum-test.log; then
              echo "âŒ ISSUE: Simulator not found"
            fi
            if grep -qi "error\|failed\|fatal" /tmp/hive-goethereum-test.log; then
              echo "âŒ ISSUE: Errors detected in output"
              grep -i "error\|failed\|fatal" /tmp/hive-goethereum-test.log | head -10
            fi
            if grep -qi "simulator.*started\|running.*test" /tmp/hive-goethereum-test.log; then
              echo "âœ“ Simulators appear to have started"
            fi
            
            # If exit code is non-zero, show error
            if [ $HIVE_EXIT_CODE -ne 0 ]; then
              echo ""
              echo "âš ï¸ Hive exited with error code: $HIVE_EXIT_CODE"
              echo "This may be expected if tests failed, but results should still be produced"
              echo ""
              echo "Last 50 lines of output:"
              tail -50 /tmp/hive-goethereum-test.log
            else
              echo ""
              echo "âœ“ Hive exited successfully (code: $HIVE_EXIT_CODE)"
            fi
            
            # Always check for results, even if exit code was non-zero
            # (tests might fail but still produce results)
            echo ""
            echo "=== Checking for test results (regardless of exit code) ==="
            if [ ! -d "$RESULTS_DIR" ] || [ -z "$(find "$RESULTS_DIR" -type f 2>/dev/null)" ]; then
              echo ""
              echo "âš ï¸ WARNING: No results found after test completion"
              echo "This may indicate tests didn't run or no simulators were found"
              echo ""
              echo "Checking available simulators..."
              echo "Simulators directory:"
              ls -la simulators/ 2>/dev/null | head -10 || echo "Simulators directory not found"
              echo ""
              echo "=== CRITICAL: Analyzing why no results were produced ==="
              echo ""
              echo "Hive exit code: $HIVE_EXIT_CODE"
              echo ""
              echo "Checking if Hive actually started simulators..."
              if grep -qi "simulator\|starting\|running" /tmp/hive-goethereum-test.log; then
                echo "âœ“ Hive output mentions simulators"
                grep -i "simulator\|starting\|running" /tmp/hive-goethereum-test.log | head -10
              else
                echo "âœ— No simulator-related output found!"
                echo "This suggests Hive may not have found or started any simulators"
              fi
              echo ""
              echo "Checking for client-related output..."
              grep -i "client\|gethrelay\|go-ethereum" /tmp/hive-goethereum-test.log | head -10 || echo "No client mentions found"
              echo ""
              echo "=== IMPORTANT: Since no results were found, this is likely a configuration issue ==="
              echo "Possible causes:"
              echo "  1. Simulators not found (check simulator directory)"
              echo "  2. Client not recognized (check client directory)"
              echo "  3. Tests completed but didn't produce output (check Hive output above)"
              echo ""
              
              # Show first and last 20 lines of Hive output for quick analysis
              echo "=== First 20 lines of Hive output ==="
              head -20 /tmp/hive-goethereum-test.log 2>/dev/null || echo "Log file not found"
              echo ""
              echo "=== Last 20 lines of Hive output ==="
              tail -20 /tmp/hive-goethereum-test.log 2>/dev/null || echo "Log file not found"
              echo ""
              
              # Check if this is a "no simulators found" scenario
              if ! grep -qi "simulator\|test\|start" /tmp/hive-goethereum-test.log 2>/dev/null; then
                echo "âŒ CRITICAL: Hive output contains no simulator/test mentions!"
                echo "## âŒ CRITICAL ISSUE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Root Cause:** Hive output contains no simulator/test mentions!" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "The Hive command that was run:" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "hive --sim=ethereum/rpc-compat --client=go-ethereum:local --loglevel=5 --sim.timelimit=15m --results-root=$RESULTS_DIR" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**This likely means:**" >> $GITHUB_STEP_SUMMARY
                echo "- The simulator \`ethereum/rpc-compat\` doesn't exist" >> $GITHUB_STEP_SUMMARY
                echo "- Or the simulator path/name is incorrect" >> $GITHUB_STEP_SUMMARY
                echo "- Or Hive isn't finding simulators in the expected location" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Full Hive Output:**" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                cat /tmp/hive-goethereum-test.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Log file empty or not found" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              fi
              # Check if client was actually discovered
              if grep -qi "unknown client" /tmp/hive-goethereum-test.log; then
                echo ""
                echo "âŒ FATAL: Hive still cannot discover go-ethereum:local client!"
                echo "This means the client image build or discovery mechanism is not working."
                echo ""
                echo "Diagnostics:"
                echo "- Client directory: $(ls -d clients/go-ethereum 2>/dev/null || echo 'NOT FOUND')"
                echo "- Dockerfile.local exists: $(test -f clients/go-ethereum/Dockerfile.local && echo 'YES' || echo 'NO')"
                echo "- Client image tags:"
                docker images | grep -E "go-ethereum|hive.*client" || echo "  No matching images"
                echo ""
                echo "Failing step because tests cannot run without client discovery."
                exit 1
              fi
              # Don't fail here - let the diagnostics step show what happened
              # But continue to allow diagnostics to run
            else
              echo ""
              echo "âœ“ Results directory exists and contains files!"
              find "$RESULTS_DIR" -type f | head -10
              echo ""
              echo "âœ“ Tests completed - results found even if exit code was non-zero"
            fi
          fi
        continue-on-error: false  # Fail if client discovery doesn't work

      - name: Run devp2p tests
        working-directory: /tmp/hive
        run: |
          echo "=== Running devp2p tests ==="
          echo ""
          
          # Set results directory
          RESULTS_DIR="./test-results-devp2p"
          mkdir -p "$RESULTS_DIR"
          
          # Try gethrelay:local first, fallback to go-ethereum:local if needed
          echo "Attempting to run devp2p tests with gethrelay:local..."
          set +e  # Don't exit on error so we can try fallback
          hive --sim=devp2p \
                  --client=gethrelay:local \
                  --loglevel=5 \
                  --sim.timelimit=15m \
                  --results-root="$RESULTS_DIR" 2>&1 | tee /tmp/hive-devp2p-test.log
          HIVE_EXIT_CODE=$?
          set -e
          
          if [ $HIVE_EXIT_CODE -eq 0 ]; then
            echo "âœ“ gethrelay:local succeeded for devp2p!"
            echo ""
            echo "Results saved to: $RESULTS_DIR"
            find "$RESULTS_DIR" -type f | head -10
            exit 0
          else
            echo ""
            echo "âœ— gethrelay:local failed for devp2p (exit code: $HIVE_EXIT_CODE) - using go-ethereum:local workaround"
            echo "Error output:"
            cat /tmp/hive-devp2p-test.log
            echo ""
            
            # Ensure go-ethereum is configured for gethrelay (from RPC test step)
            # If not already done, set it up
            if [ ! -f clients/go-ethereum/Dockerfile.local.backup ]; then
              echo "Setting up go-ethereum workaround..."
              cp clients/go-ethereum/Dockerfile.local clients/go-ethereum/Dockerfile.local.backup
              cat > clients/go-ethereum/Dockerfile.local << 'EOF'
          FROM ethereum/gethrelay:latest
          USER root
          RUN apk add --update --no-cache bash curl jq
          COPY geth.sh /geth.sh
          COPY enode.sh /hive-bin/enode.sh
          COPY mapper.jq /mapper.jq
          RUN chmod +x /geth.sh /hive-bin/enode.sh
          USER gethrelay
          EXPOSE 8545 8546 8547 8551 30303 30303/udp
          ENTRYPOINT ["/geth.sh"]
          EOF
              sed -i 's|exec geth|exec gethrelay|g' clients/go-ethereum/geth.sh
              
              echo "Building go-ethereum client image for devp2p tests..."
              cd clients/go-ethereum
              if ! docker build -f Dockerfile.local -t hive/clients/go-ethereum:local .; then
                echo "âŒ ERROR: Failed to build go-ethereum client image!"
                cd ../..
                exit 1
              fi
              cd ../..
              echo "âœ“ Client image built successfully"
            fi
            
            # Set results directory for fallback
            RESULTS_DIR="./test-results"
            mkdir -p "$RESULTS_DIR"
            
            echo "Running Hive with go-ethereum:local (using gethrelay)..."
            if hive --sim=devp2p \
                    --client=go-ethereum:local \
                    --loglevel=5 \
                    --sim.timelimit=15m \
                    --results-root="$RESULTS_DIR" 2>&1 | tee /tmp/hive-devp2p-goethereum.log; then
              echo ""
              echo "âœ“ Tests completed successfully!"
              echo "Results saved to: $RESULTS_DIR"
              find "$RESULTS_DIR" -type f | head -10
              echo ""
              echo "Directory structure:"
              ls -laR "$RESULTS_DIR" | head -30
            else
              echo "âš ï¸ Tests failed or exited with error"
              echo "But checking for results anyway..."
              echo "Last 50 lines of log:"
              tail -50 /tmp/hive-devp2p-goethereum.log
              echo ""
              # Check if results exist even though exit code was non-zero
              if [ -d "$RESULTS_DIR" ] && [ -n "$(find "$RESULTS_DIR" -type f 2>/dev/null)" ]; then
                echo "âœ“ Results found despite non-zero exit code!"
                find "$RESULTS_DIR" -type f | head -10
              else
                echo "âœ— No results found"
                # Check if client discovery failed
                if grep -qi "unknown client" /tmp/hive-devp2p-goethereum.log 2>/dev/null; then
                  echo ""
                  echo "âŒ FATAL: Client discovery failed for devp2p tests too!"
                  exit 1
                fi
              fi
            fi
          fi
        continue-on-error: false  # Fail if client discovery doesn't work

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: hive-test-results
          path: |
            /tmp/hive/test-results*
            /tmp/hive/test-results*/**
            /tmp/hive/**/*.log
            /tmp/hive/workspace/logs/**
          retention-days: 7
          if-no-files-found: warn
          compression-level: 0

      - name: Comprehensive diagnostics before summary
        if: always()
        working-directory: /tmp/hive
        run: |
          echo "=== COMPREHENSIVE DIAGNOSTICS ==="
          echo ""
          echo "1. Current working directory: $(pwd)"
          echo ""
          echo "2. All directories in current location:"
          ls -la | head -20
          echo ""
          echo "3. Searching for test-results directories:"
          find . -type d \( -name "*test*" -o -name "*result*" \) 2>/dev/null | head -20
          echo ""
          echo "4. All .log files anywhere:"
          find . -name "*.log" -type f 2>/dev/null | head -30
          echo ""
          echo "5. Workspace directory (Hive default):"
          if [ -d "workspace" ]; then
            echo "âœ“ workspace exists"
            find workspace -type f 2>/dev/null | head -20
            echo "Workspace structure:"
            tree workspace -L 3 2>/dev/null || find workspace -type d | head -20
          else
            echo "âœ— workspace does not exist"
          fi
          echo ""
          echo "6. All directories recursively (max depth 3):"
          find . -maxdepth 3 -type d | grep -E "(test|result|log|workspace)" | head -20
          echo ""
          echo "7. Recent files modified (last 10 minutes):"
          find . -type f -mmin -10 2>/dev/null | head -20
          echo ""
          echo "8. Hive log files in /tmp:"
          ls -lah /tmp/hive*.log 2>/dev/null || echo "No hive log files in /tmp"
          if [ -f /tmp/hive-goethereum-test.log ]; then
            echo "RPC test log size: $(wc -l < /tmp/hive-goethereum-test.log) lines"
          fi
          if [ -f /tmp/hive-devp2p-goethereum.log ]; then
            echo "devp2p test log size: $(wc -l < /tmp/hive-devp2p-goethereum.log) lines"
          fi
          echo ""
          echo "9. Docker containers (Hive might leave containers):"
          docker ps -a | grep -E "(hive|gethrelay|ethereum)" | head -10 || echo "No relevant containers"
          echo ""
          echo "10. Check if simulators directory exists and what's in it:"
          if [ -d "simulators" ]; then
            echo "Simulators found:"
            find simulators -maxdepth 2 -type d | head -30
            echo ""
            echo "Checking if ethereum/rpc-compat exists:"
            test -d "simulators/ethereum/rpc-compat" && echo "âœ“ simulators/ethereum/rpc-compat exists" || echo "âœ— simulators/ethereum/rpc-compat NOT found"
            echo "Checking if devp2p exists:"
            test -d "simulators/devp2p" && echo "âœ“ simulators/devp2p exists" || echo "âœ— simulators/devp2p NOT found"
          else
            echo "âœ— Simulators directory does not exist!"
          fi
          echo ""
          
      - name: Test summary
        if: always()
        working-directory: /tmp/hive
        run: |
          echo "## Hive Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find all test result directories
          echo "=== Searching for test results ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "All test-results directories:"
          find . -type d -name "test-results*" 2>/dev/null | head -20
          echo ""
          echo "All simulator.log files:"
          find . -name "simulator.log" 2>/dev/null | head -20
          echo ""
          echo "All .log files:"
          find . -name "*.log" -type f 2>/dev/null | head -20
          echo ""
          
          # Check workspace directory (Hive default)
          if [ -d "workspace/logs" ]; then
            echo "Found Hive workspace/logs directory"
            find workspace/logs -type f | head -10
          fi
          echo ""
          
          # Check RPC test results in multiple locations
          echo "### RPC Tests" >> $GITHUB_STEP_SUMMARY
          RPC_RESULTS=""
          RPC_DIRS=("./test-results-rpc" "./test-results" "workspace/logs" "./workspace/logs")
          
          # Also check if results might be in subdirectories
          for base_dir in "${RPC_DIRS[@]}"; do
            if [ -d "$base_dir" ]; then
              # Check for simulator.log in any subdirectory
              RESULT_FILE=$(find "$base_dir" -name "simulator.log" -type f 2>/dev/null | head -1)
              if [ -n "$RESULT_FILE" ] && [ -f "$RESULT_FILE" ]; then
                RPC_RESULTS="$RESULT_FILE"
                echo "âœ“ Found RPC results at: $RESULT_FILE" >> $GITHUB_STEP_SUMMARY
                break
              fi
              # Also check for any test result files
              if [ -n "$(find "$base_dir" -type f 2>/dev/null | head -1)" ]; then
                echo "Found files in $base_dir:" >> $GITHUB_STEP_SUMMARY
                find "$base_dir" -type f | head -5 >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          if [ -n "$RPC_RESULTS" ] && [ -f "$RPC_RESULTS" ]; then
            echo "Found RPC results at: $RPC_RESULTS" >> $GITHUB_STEP_SUMMARY
            PASSED=$(grep -c "pass=true" "$RPC_RESULTS" 2>/dev/null || echo "0")
            FAILED=$(grep -c "pass=false" "$RPC_RESULTS" 2>/dev/null || echo "0")
            TOTAL=$(grep -c "pass=" "$RPC_RESULTS" 2>/dev/null || echo "0")
            echo "- Total: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            if [ "$TOTAL" -gt 0 ]; then
              echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Log file exists but no pass/fail entries found" >> $GITHUB_STEP_SUMMARY
              echo "Sample log content:" >> $GITHUB_STEP_SUMMARY
              head -20 "$RPC_RESULTS" | sed 's/^/  /' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ No RPC test results found" >> $GITHUB_STEP_SUMMARY
            echo "Searched in: test-results-rpc, test-results, workspace/logs" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check devp2p test results in multiple locations  
          echo "### devp2p Tests" >> $GITHUB_STEP_SUMMARY
          DEVP2P_RESULTS=""
          DEVP2P_DIRS=("./test-results-devp2p" "./test-results" "workspace/logs" "./workspace/logs")
          
          # Also check if results might be in subdirectories
          for base_dir in "${DEVP2P_DIRS[@]}"; do
            if [ -d "$base_dir" ]; then
              # Check for simulator.log in any subdirectory
              RESULT_FILE=$(find "$base_dir" -name "simulator.log" -type f 2>/dev/null | head -1)
              if [ -n "$RESULT_FILE" ] && [ -f "$RESULT_FILE" ]; then
                DEVP2P_RESULTS="$RESULT_FILE"
                echo "âœ“ Found devp2p results at: $RESULT_FILE" >> $GITHUB_STEP_SUMMARY
                break
              fi
              # Also check for any test result files
              if [ -n "$(find "$base_dir" -type f 2>/dev/null | head -1)" ]; then
                echo "Found files in $base_dir:" >> $GITHUB_STEP_SUMMARY
                find "$base_dir" -type f | head -5 >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          if [ -n "$DEVP2P_RESULTS" ] && [ -f "$DEVP2P_RESULTS" ]; then
            echo "Found devp2p results at: $DEVP2P_RESULTS" >> $GITHUB_STEP_SUMMARY
            PASSED=$(grep -c "pass=true" "$DEVP2P_RESULTS" 2>/dev/null || echo "0")
            FAILED=$(grep -c "pass=false" "$DEVP2P_RESULTS" 2>/dev/null || echo "0")
            TOTAL=$(grep -c "pass=" "$DEVP2P_RESULTS" 2>/dev/null || echo "0")
            echo "- Total: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            if [ "$TOTAL" -gt 0 ]; then
              echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Log file exists but no pass/fail entries found" >> $GITHUB_STEP_SUMMARY
              echo "Sample log content:" >> $GITHUB_STEP_SUMMARY
              head -20 "$DEVP2P_RESULTS" | sed 's/^/  /' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ No devp2p test results found" >> $GITHUB_STEP_SUMMARY
            echo "Searched in: test-results-devp2p, test-results, workspace/logs" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show any available log files (including captured Hive logs)
          echo "### Available Log Files" >> $GITHUB_STEP_SUMMARY
          LOG_COUNT=$(find . -name "*.log" -type f 2>/dev/null | wc -l)
          if [ "$LOG_COUNT" -gt 0 ]; then
            find . -name "*.log" -type f 2>/dev/null | head -15 | while read logfile; do
              SIZE=$(du -h "$logfile" 2>/dev/null | cut -f1)
              echo "- \`$logfile\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
            done
          fi
          
          # Also check captured Hive test logs in /tmp
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Captured Hive Test Logs" >> $GITHUB_STEP_SUMMARY
          for log in /tmp/hive-goethereum-test.log /tmp/hive-devp2p-goethereum.log /tmp/hive-gethrelay-test.log /tmp/hive-devp2p-test.log; do
            if [ -f "$log" ] && [ -s "$log" ]; then
              SIZE=$(du -h "$log" 2>/dev/null | cut -f1)
              LINES=$(wc -l < "$log" 2>/dev/null || echo "0")
              echo "- \`$log\` ($SIZE, $LINES lines)" >> $GITHUB_STEP_SUMMARY
              # Show key information from the log
              if grep -qi "error\|failed\|unknown" "$log"; then
                echo "  âš ï¸ Contains errors:" >> $GITHUB_STEP_SUMMARY
                grep -i "error\|failed\|unknown" "$log" | head -3 | sed 's/^/    - /' >> $GITHUB_STEP_SUMMARY
              fi
              if grep -qi "simulator.*started\|running.*test\|test.*completed" "$log"; then
                echo "  âœ“ Contains test execution markers" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          if [ "$LOG_COUNT" -eq 0 ] && [ ! -f /tmp/hive-goethereum-test.log ] && [ ! -f /tmp/hive-devp2p-goethereum.log ]; then
            echo "No log files found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This suggests Hive tests did not execute or failed immediately.**" >> $GITHUB_STEP_SUMMARY
            echo "Check the test execution steps above for error messages." >> $GITHUB_STEP_SUMMARY
          fi

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: success() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (success)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            âœ… *gethrelay CI Passed*
            
            All tests completed successfully!
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, hive-tests]
    if: failure() && (github.event_name != 'workflow_dispatch' || github.event.inputs.notify != 'false')
    steps:
      - name: Send Telegram notification (failure)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            âŒ *gethrelay CI Failed*
            
            Some tests or builds failed. Please check the logs.
            
            *Commit:* `${{ github.sha }}`
            *Branch:* `${{ github.ref_name }}`
            
            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

