name: Gethrelay Module Tests

on:
  push:
    # Run on all branches when gethrelay code changes
    paths:
      - 'cmd/gethrelay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-module-tests.yml'
  pull_request:
    # Run on PRs to any branch
    paths:
      - 'cmd/gethrelay/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/gethrelay-module-tests.yml'
  workflow_dispatch:
    # Allow manual trigger

env:
  GO_VERSION: '1.24'

jobs:
  unit-tests:
    name: Module Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.sum

      - name: Verify Go version
        run: go version

      - name: Run module tests
        working-directory: ./cmd/gethrelay
        run: |
          echo "Running gethrelay unit tests..."
          go test -v -race -coverprofile=coverage.out -covermode=atomic .
          
          echo ""
          echo "Test coverage:"
          go tool cover -func=coverage.out | tail -1

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./cmd/gethrelay/coverage.out
          flags: gethrelay
          name: gethrelay-coverage

      - name: Test summary
        if: always()
        run: |
          echo "## Module Tests Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f ./cmd/gethrelay/coverage.out ]; then
            COVERAGE=$(go tool cover -func=./cmd/gethrelay/coverage.out | grep total | awk '{print $3}')
            echo "- **Coverage**: $COVERAGE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

