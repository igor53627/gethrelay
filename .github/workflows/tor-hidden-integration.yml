name: tor-hidden-integration

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["build-tor-image"]
    types:
      - completed
  pull_request:
    paths:
      - node/**
      - tests/torhidden/**
      - docker/tor/**
      - go.mod
      - go.sum

jobs:
  test:
    runs-on: ubuntu-latest
    # Only run if workflow_run was successful or triggered by other events
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      packages: read
    env:
      GETH_TOR_IMAGE: ghcr.io/${{ github.repository_owner }}/geth-tor-hidden-service:latest
      TOR_INTEGRATION_TEST: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if Tor image exists
        id: check-image
        continue-on-error: true
        run: |
          if docker pull $GETH_TOR_IMAGE 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Tor image exists and was pulled successfully"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Tor image does not exist yet"
          fi

      - name: Build Tor image if not available
        if: steps.check-image.outputs.exists != 'true'
        run: |
          echo "Building Tor image from docker/tor/Dockerfile..."
          docker build -t $GETH_TOR_IMAGE -f docker/tor/Dockerfile .
          echo "✅ Tor image built successfully"

      - name: Run hidden service integration test
        run: |
          go test ./tests/torhidden -run TestHiddenServiceIntegration -timeout 10m
